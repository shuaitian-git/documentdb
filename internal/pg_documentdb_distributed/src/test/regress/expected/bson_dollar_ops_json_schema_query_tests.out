set search_path to documentdb_core,documentdb_api,documentdb_api_catalog,pg_catalog;
SET citus.next_shard_id TO 7700000;
SET documentdb.next_collection_id TO 7700;
SET documentdb.next_collection_index_id TO 7700;
SELECT documentdb_api.insert_one('db', 'col_bson_dollar_ops_json_schema_query', '{ 
    "_id": 0, "itemType": "alpha", "count" : 4, "flag" : true, 
    "height" : 5.8, "width" : { "$numberDecimal": "4.2" }, 
    "details" : { "year" : 2020, "shade" : "black" }, 
    "features": ["optionA", {"drive": "front"}, {"extra": true, "free": true} ], 
    "engine": { "cc": 1500, "fuel": "petrol" }
}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'col_bson_dollar_ops_json_schema_query', '{ 
    "_id": 1, "itemType": 20, "count" : "many", "flag" : "1 ton", 
    "height" : "very high", "width" : { "upper" : 10, "lower" : 20 }, 
    "details" : 2010, 
    "features": null, 
    "engine": 1500
}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

---------------------------------------------------------------------
--                         Common Validations                                --
---------------------------------------------------------------------
---------------------------- "type" -------------------------------------------
-- All docs Match
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
 { "_id" : { "$numberInt" : "1" }, "itemType" : { "$numberInt" : "20" }, "count" : "many", "flag" : "1 ton", "height" : "very high", "width" : { "upper" : { "$numberInt" : "10" }, "lower" : { "$numberInt" : "20" } }, "details" : { "$numberInt" : "2010" }, "features" : null, "engine" : { "$numberInt" : "1500" } }
(2 rows)

-- All docs Match, as none of docs have given field
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "cosmosdb" : { "type" : "string" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
 { "_id" : { "$numberInt" : "1" }, "itemType" : { "$numberInt" : "20" }, "count" : "many", "flag" : "1 ton", "height" : "very high", "width" : { "upper" : { "$numberInt" : "10" }, "lower" : { "$numberInt" : "20" } }, "details" : { "$numberInt" : "2010" }, "features" : null, "engine" : { "$numberInt" : "1500" } }
(2 rows)

-- No Match
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "type" : "boolean" } } } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- Matches where "itemType" is "string"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "type" : "string" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "count" is "number"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "count" : { "type" : "number" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "height" is "number"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "height" : { "type" : "number" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "width" is "number"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "width" : { "type" : "number" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "details" is "object"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "details" : { "type" : "object" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "features" is "array"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "features" : { "type" : "array" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "flag" is "boolean"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "flag" : { "type" : "boolean" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "itemType" is "string" and "count" is "number"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "type" : "string" }, "count" : { "type" : "number" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Unsupported: "integer" type
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "count" : { "type" : "integer" } } } }');
ERROR:  The 'integer' type in $jsonSchema is not supported at this time.
---------------------------- "bsonType" -------------------------------------------
-- All docs Match, as none of docs have given field
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "cosmosdb" : { "bsonType" : "string" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
 { "_id" : { "$numberInt" : "1" }, "itemType" : { "$numberInt" : "20" }, "count" : "many", "flag" : "1 ton", "height" : "very high", "width" : { "upper" : { "$numberInt" : "10" }, "lower" : { "$numberInt" : "20" } }, "details" : { "$numberInt" : "2010" }, "features" : null, "engine" : { "$numberInt" : "1500" } }
(2 rows)

-- No Match
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "bsonType" : "bool" } } } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- Matches where "itemType" is "string"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "bsonType" : "string" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "count" is "int"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "count" : { "bsonType" : "int" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "height" is "double"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "height" : { "bsonType" : "double" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "width" is "decimal"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "width" : { "bsonType" : "decimal" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "details" is "object"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "details" : { "bsonType" : "object" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "features" is "array"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "features" : { "bsonType" : "array" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "flag" is "boolean"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "flag" : { "bsonType" : "bool" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Matches where "itemType" is "string" and "count" is "int"
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "itemType" : { "bsonType" : "string" }, "count" : { "bsonType" : "int" } } } }');
                                                                                                                                                                                                                   document                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }
(1 row)

-- Unsupported: "integer" type
SELECT document FROM documentdb_api.collection('db', 'col_bson_dollar_ops_json_schema_query') WHERE documentdb_api_catalog.bson_dollar_json_schema(document,'{ "$jsonSchema": { "properties": { "count" : { "type" : "integer" } } } }');
ERROR:  The 'integer' type in $jsonSchema is not supported at this time.
---------------------------------------------------------------------
--                         Numeric Validations                               --
---------------------------------------------------------------------
--------------------------- multipleOf ----------------------------------------
-- Doc is valid as field's value is a multiple of "multipleOf"
SELECT bson_dollar_json_schema('{"size": 0}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.4}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2.2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--In the following test doc is evaluated as invalid, because psql converts double value of 1.1 to 1.1000000000000001, which is not a multiple of 11
--This would not happen when req comes from gateway. So commenting out this test in psql, but will add this test as JS test in Gateway
--SELECT bson_dollar_json_schema('{"size": 11}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : {"$numberDouble" : "1.1"} } } } }');
-- Doc is invalid as field's value is not a multiple of "multipleOf"
SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 3 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.4}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if field is not numeric
SELECT bson_dollar_json_schema('{"size": "hello"}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": [5]}','{ "$jsonSchema": { "properties": { "size" : { "multipleOf" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--------------------------- maximum ----------------------------------------
-- Doc is valid as field's value is less than or equal to given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 2}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as field's value is more than the given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.2}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if field is not numeric
SELECT bson_dollar_json_schema('{"size": "hello"}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": [5]}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--------------------------- exclusiveMaximum -------------------------------
-- When "exclusiveMaximum" is true, these doc are valid as field's value is strictly less than the given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 3}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 3.99}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 3.99}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- When "exclusiveMaximum" is true, these doc are invalid as field's value is more than or equal to the given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"}, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"}, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- When "exclusiveMaximum" is false, these doc are valid as field's value is less than or equal to the given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 2}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- When "exclusiveMaximum" is false, these doc are invalid as field's value is more than the given value of "maximum"
SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.2}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4.1, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "-INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "NaN"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : {"$numberDecimal" : "INF"}, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if field is not numeric
SELECT bson_dollar_json_schema('{"size": "hello"}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": [5]}','{ "$jsonSchema": { "properties": { "size" : { "maximum" : 4, "exclusiveMaximum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--------------------------- minimum ----------------------------------------
-- Doc is valid as field's value is more than or equal to given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.2}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "NaN"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as field's value is less than the given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 3}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 3.9}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.11 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if field is not numeric
SELECT bson_dollar_json_schema('{"size": "hello"}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": [5]}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--------------------------- exclusiveMinimum -------------------------------
-- When "exclusiveMinimum" is true, these doc are valid as field's value is strictly more than the given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.11}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- When "exclusiveMinimum" is true, these doc are invalid as field's value is less than or equal to the given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 3}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 3.99}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"}, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "NaN"}, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- When "exclusiveMinimum" is false, these doc are valid as field's value is more than or equal to the given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.2}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 5}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "NaN"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- When "exclusiveMinimum" is false, these doc are invalid as field's value is less than the given value of "minimum"
SELECT bson_dollar_json_schema('{"size": 3}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 3.9}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.1, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": 4.1}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4.11, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "-INF"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"size": {"$numberDecimal" : "NaN"}}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : {"$numberDecimal" : "-INF"}, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if field is not numeric
SELECT bson_dollar_json_schema('{"size": "hello"}','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"size": [3] }','{ "$jsonSchema": { "properties": { "size" : { "minimum" : 4, "exclusiveMinimum" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------------------------------------------------
--                         String Validations                                --
---------------------------------------------------------------------
--------------------------- maxLength ----------------------------------------
-- Doc is valid as length of string is less than or eq to maxLength
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "maxLength" : 10 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "maxLength" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as length of string is less than or eq to maxLength
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "maxLength" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if property is not a string
SELECT bson_dollar_json_schema('{"name": 2}','{ "$jsonSchema": { "properties": { "name" : { "maxLength" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

--------------------------- minLength ----------------------------------------
-- Doc is valid as length of string is more than or eq to minLength
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "minLength" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "minLength" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as length of string is more than the minLength
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "minLength" : 10 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid if property is not a string
SELECT bson_dollar_json_schema('{"name": 2}','{ "$jsonSchema": { "properties": { "name" : { "minLength" : 4 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------- pattern -----------------------------------------
-- Doc is valid as given pattern matches the string
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "pattern" : "^P" } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "pattern" : "[auzP]" } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as given pattern does not matches the string
SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "pattern" : "^a" } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"name":"Pazu"}','{ "$jsonSchema": { "properties": { "name" : { "pattern" : "$z" } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

---------------------------------------------------------------------
--                         Array Validations                                --
---------------------------------------------------------------------
---------------------------- items --------------------------------------------
-- Doc is valid as "data" array's each value matches the schema given in "items"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" } ] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}, { "type" : "boolean" }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "minLength" : 1, "maxLength" : 10 }, { "type":"object" }, { "minimum" : 1, "maximum": 5 }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as "data" array's each value does matches the schema given in "items"
SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "object" }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"number" }] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid when "items" is given for Non-Array fields
SELECT bson_dollar_json_schema('{"data" : 2 }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" } ] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : "Hello" }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "number" } ] } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------- additionalItems ----------------------------------
-- Doc is valid as "data" array values matches the schema given in "items", and data array has no more members than the number of members listed in "items"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}, { "type" : "boolean" }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "minLength" : 1, "maxLength" : 10 }, { "type":"object" }, { "minimum" : 1, "maximum": 5 }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as "data" array has more members than the number of members listed in "items"
SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid as "data" array values matches the schema given in "items", while data array can have more members than number of members listed in "items"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }, { "type":"object" }, { "type": "number"}, { "type" : "boolean" }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "minLength" : 1, "maxLength" : 10 }, { "type":"object" }, { "minimum" : 1, "maximum": 5 }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is valid, if "items" keyword is not provided, since "additionalItems" has no effect without "items"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello" ] }','{ "$jsonSchema": { "properties": { "data" : { "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello" ] }','{ "$jsonSchema": { "properties": { "data" : { "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is valid, if "additionalItems" is provided for Non-Array fields
SELECT bson_dollar_json_schema('{"data" : 2 }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : 2 }','{ "$jsonSchema": { "properties": { "data" : { "items" : [{ "type" : "string" }], "additionalItems" : false } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------- maxItems -----------------------------------------
-- Doc is valid as "data" array members are less than or equal to given "maxItems"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 0 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello" ] }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1} ] }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as "data" array members are more than the given "maxItems"
SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid when "maxItems" is given for Non-Array fields
SELECT bson_dollar_json_schema('{"data" : 2 }','{ "$jsonSchema": { "properties": { "data" : { "maxItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------- minItems -----------------------------------------
-- Doc is valid as "data" array members are more than or equal to given "minItems"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 0 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1} ] }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello", {"a":1}, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as "data" array members are less than the given "minItems"
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hello" ] }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 2 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid when "minItems" is given for Non-Array fields
SELECT bson_dollar_json_schema('{"data" : 2 }','{ "$jsonSchema": { "properties": { "data" : { "minItems" : 1 } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------- uniqueItems --------------------------------------
-- Doc is valid as all items in the given array are unique
SELECT bson_dollar_json_schema('{"data" : [ ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, 2 ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, 1.1 ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"1":1}, "1" ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"1":1}, "1", true ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"a":1}, {"b":1} ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"a":1, "b":1}, {"a":2, "b":2} ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"a":1, "b":1}, {"a":2, "b":2} ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- Doc is invalid as all items in the given array are not unique
SELECT bson_dollar_json_schema('{"data" : [ 1, 1 ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, 1.0 ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, true, true ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ false, 1, false ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ "Hi", "Hi", 1 ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is invalid, as objects that have same key-value pairs, even in different orders, are not unique. Applicable to objects recursively (i.e. objects in objects)
SELECT bson_dollar_json_schema('{"data" : [ 1, {"a":1, "b":2}, {"b":2, "a":1} ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : [ 1, {"a": {"x":5, "y": 6}, "b":2}, {"b":2, "a": {"y":6, "x":5}} ] }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

-- Doc is valid when "uniqueItems" is given for Non-Array fields
SELECT bson_dollar_json_schema('{"data" : 1 }','{ "$jsonSchema": { "properties": { "data" : { "uniqueItems" : true } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

---------------------------------------------------------------------
--                         Binary Validations                                --
---------------------------------------------------------------------
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : 1}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 f
(1 row)

SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {"keyId": ["9e4cfa3e-2b56-4e20-9fd3-3c3708056a18"], "algorithm":"AEAD_AES_256_CBC_HMAC_SHA_512-Random", "bsonType":"string"} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema":  {"encryptMetadata": {"keyId": ["9e4cfa3e-2b56-4e20-9fd3-3c3708056a18"], "algorithm":"AEAD_AES_256_CBC_HMAC_SHA_512-Random"} } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- negative test cases
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema":  {"encryptMetadata": "test"} }');
ERROR:  $jsonSchema keyword 'encryptMetadata' must be a document
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema":  {"encryptMetadata": {}} }');
ERROR:  $jsonSchema keyword 'encryptMetadata' cannot be an empty object
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema":  {"encryptMetadata": {"unknown":"hello"}} }');
ERROR:  The BSON field 'encryptMetadata.unknown' is not recognized as a valid or supported field.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema":  {"encryptMetadata": {"keyId":1}} }');
ERROR:  The BSON field 'encryptMetadata.keyId' has an incorrect type 'int'; it should be of type 'array'.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema":  {"encryptMetadata": {"algorithm":[]}} }');
ERROR:  The BSON field 'encryptMetadata.algorithm' has an incorrect type 'array'; it should be of type 'string'.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {"a":1} } } } }');
ERROR:  The BSON field 'encrypt.a' is not recognized as a valid field.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {"keyId":1} } } } }');
ERROR:  The BSON field 'encrypt.keyId' has an incorrect type 'int'; it should be of type 'array'.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {"algorithm":[]} } } } }');
ERROR:  The BSON field 'encrypt.algorithm' has an incorrect type 'array'; it should be of type 'string'.
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {"bsonType": 123} } } } }');
ERROR:  $jsonSchema keyword 'bsonType' must be either a string or an array of strings
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : "" } } } }'); 
ERROR:  $jsonSchema keyword 'encrypt' must be a document
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {}, "type":"string" } } } }'); 
ERROR:  'encrypt' implies 'bsonType: BinData' and cannot be combined with 'type' in $jsonSchema
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {}, "bsonType":"string" } } } }'); 
ERROR:  'encrypt' implies 'bsonType: BinData' and cannot be combined with 'type' in $jsonSchema
-- guc test cases
set documentdb.enableSchemaEnforcementForCSFLE = false;
SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "06" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : 1}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

SELECT bson_dollar_json_schema('{"data" : { "$binary" : { "base64" : "AAAAAAAAAAAAAAAAAAAAAAAAAAAA", "subType" : "01" }}}','{ "$jsonSchema": { "properties": { "data" : { "encrypt" : {} } } } }');
 bson_dollar_json_schema 
---------------------------------------------------------------------
 t
(1 row)

-- $jsonSchema will be supported in query condition later
---------------------------------------------------------------------
--                         $jsonSchema in query condition                    --
---------------------------------------------------------------------
-- All docs Match
SELECT cursorPage FROM documentdb_api.find_cursor_first_page('db', '{ "find" : "col_bson_dollar_ops_json_schema_query", "filter" : { "$jsonSchema": { "properties": { } } }, "$db" : "db" }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                             cursorpage                                                                                                                                                                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.col_bson_dollar_ops_json_schema_query", "firstBatch" : [ { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } }, { "_id" : { "$numberInt" : "1" }, "itemType" : { "$numberInt" : "20" }, "count" : "many", "flag" : "1 ton", "height" : "very high", "width" : { "upper" : { "$numberInt" : "10" }, "lower" : { "$numberInt" : "20" } }, "details" : { "$numberInt" : "2010" }, "features" : null, "engine" : { "$numberInt" : "1500" } } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- -- No Match
SELECT cursorPage FROM documentdb_api.find_cursor_first_page('db', '{ "find" : "col_bson_dollar_ops_json_schema_query", "filter" : { "$jsonSchema": { "properties": { "itemType" : { "type" : "boolean" } } } }, "$db" : "db" }');
                                                                          cursorpage                                                                           
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.col_bson_dollar_ops_json_schema_query", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- -- Matches where "vehicle" is "string"
SELECT cursorPage FROM documentdb_api.find_cursor_first_page('db', '{ "find" : "col_bson_dollar_ops_json_schema_query", "filter" : { "$jsonSchema": { "properties": { "itemType" : { "type" : "string" } } } }, "$db" : "db" }');
                                                                                                                                                                                                                                                                                                cursorpage                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.col_bson_dollar_ops_json_schema_query", "firstBatch" : [ { "_id" : { "$numberInt" : "0" }, "itemType" : "alpha", "count" : { "$numberInt" : "4" }, "flag" : true, "height" : { "$numberDouble" : "5.7999999999999998224" }, "width" : { "$numberDecimal" : "4.2" }, "details" : { "year" : { "$numberInt" : "2020" }, "shade" : "black" }, "features" : [ "optionA", { "drive" : "front" }, { "extra" : true, "free" : true } ], "engine" : { "cc" : { "$numberInt" : "1500" }, "fuel" : "petrol" } } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)


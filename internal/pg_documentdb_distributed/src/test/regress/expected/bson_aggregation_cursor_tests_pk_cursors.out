SET search_path TO documentdb_api_catalog, documentdb_api, documentdb_core, public;
SET documentdb.next_collection_id TO 400;
SET documentdb.next_collection_index_id TO 400;
SET citus.next_shard_id TO 40000;
set documentdb.enablePrimaryKeyCursorScan to on;
-- insert 10 documents - but insert the _id as reverse order of insertion order (so that TID and insert order do not match)
DO $$
DECLARE i int;
BEGIN
FOR i IN 1..10 LOOP
PERFORM documentdb_api.insert_one('pkcursordb', 'aggregation_cursor_pk', FORMAT('{ "_id": %s, "sk": %s, "a": "%s", "c": [ %s "d" ] }',  10-i , mod(i, 2), repeat('Sample', 10), repeat('"' || repeat('a', 10) || '", ', 5))::documentdb_core.bson);
END LOOP;
END;
$$;
NOTICE:  creating collection
PREPARE drain_find_query(bson, bson) AS
    (WITH RECURSIVE cte AS (
        SELECT cursorPage, continuation FROM find_cursor_first_page(database => 'pkcursordb', commandSpec => $1, cursorId => 534)
        UNION ALL
        SELECT gm.cursorPage, gm.continuation FROM cte, cursor_get_more(database => 'pkcursordb', getMoreSpec => $2, continuationSpec => cte.continuation) gm
            WHERE cte.continuation IS NOT NULL
    )
    SELECT * FROM cte);
PREPARE drain_find_query_continuation(bson, bson) AS
    (WITH RECURSIVE cte AS (
        SELECT cursorPage, continuation FROM find_cursor_first_page(database => 'pkcursordb', commandSpec => $1, cursorId => 534)
        UNION ALL
        SELECT gm.cursorPage, gm.continuation FROM cte, cursor_get_more(database => 'pkcursordb', getMoreSpec => $2, continuationSpec => cte.continuation) gm
            WHERE cte.continuation IS NOT NULL
    )
    SELECT bson_dollar_project(cursorPage, '{"firstBatchLength": { "$size": { "$ifNull": ["$cursor.firstBatch", []]}}, "nextBatchLength": { "$size": { "$ifNull": ["$cursor.nextBatch", []]}}}'), continuation FROM cte);
-- create an index to force non HOT path
SELECT documentdb_api_internal.create_indexes_non_concurrently('pkcursordb', '{"createIndexes": "aggregation_cursor_pk", "indexes": [{"key": {"a": 1}, "name": "a_1" }]}', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- create a streaming cursor (that doesn't drain)
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk", "batchSize": 5 }', cursorId => 4294967294);
SELECT * FROM firstPageResponse;
                                                                                                                        bson_dollar_project                                                                                                                        |                                                                                                                                                                                                                                      continuation                                                                                                                                                                                                                                       | persistconnection |  cursorid  
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "firstBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "4" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "batchSize" : { "$numberInt" : "5" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE } | f                 | 4294967294
(1 row)

-- now drain it
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 6 }', continuationSpec => :'r1_continuation');
                                                                                                                   bson_dollar_project                                                                                                                   | continuation 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "nextBatch" : [ { "_id" : { "$numberInt" : "5" } }, { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "7" } }, { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "9" } } ] } } | 
(1 row)

-- drain with batchsize of 1 - continuation _ids should increase until it drains: uses pk scan continuation tokens
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAkA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "1" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAgA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "2" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAcA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "7" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "8" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "8" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(9 rows)

-- drain with batchsize of 1 - with the GUC disabled, it should be returned in reverse (TID) order
set documentdb.enablePrimaryKeyCursorScan to off;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                         continuation                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "8" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAcA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAgA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAkA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(9 rows)

set documentdb.enablePrimaryKeyCursorScan to on;
-- the query honors filters in continuations.
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                        cursorpage                                                                                         |                                                                                                                                                                                                                                                                                                          continuation                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(4 rows)

-- if a query picks a pk index scan on the first page, the second page is guaranteed to pick it:
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk",  "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 2 }', cursorId => 4294967294);
SELECT * FROM firstPageResponse;
                                                                  bson_dollar_project                                                                  |                                                                                                                                                                                                                                                                                                             continuation                                                                                                                                                                                                                                                                                                              | persistconnection |  cursorid  
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "firstBatch" : [ { "_id" : { "$numberInt" : "4" } }, { "_id" : { "$numberInt" : "5" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE } | f                 | 4294967294
(1 row)

-- disable these to ensure we pick seqscan as the default path.
set enable_indexscan to off;
set enable_bitmapscan to off;
-- now drain it partially
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 1 }', continuationSpec => :'r1_continuation');
                                               bson_dollar_project                                                |                                                                                                                                                                                                                                                                                                             continuation                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
(1 row)

-- drain it fully
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 5 }', continuationSpec => :'r1_continuation');
                                                             bson_dollar_project                                                             | continuation 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "nextBatch" : [ { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "7" } } ] } } | 
(1 row)

-- explain the first query (should be an index scan on the pk index)
set documentdb.enableCursorsOnAggregationQueryRewrite to on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }');
                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Filter: ((collection.document @> '{ "_id" : { "$numberInt" : "3" } }'::bson) AND (collection.document @< '{ "_id" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson) AND documentdb_api_internal.cursor_state(collection.document, '{ }'::bson))
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 1 }');
                                                                                                                          QUERY PLAN                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(5 rows)

-- the getmore should still work and use the _id index
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }', :'r1_continuation');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   Page Row Count: 2 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ 401, { "" : 5 } ] }
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((collection.shard_key_value = '401'::bigint) AND (ROW(collection.shard_key_value, collection.object_id) > ROW('401'::bigint, '{ "" : { "$numberInt" : "5" } }'::bson)) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "getpage_batchCount" : { "$numberInt" : "2" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
(9 rows)

set enable_indexscan to on;
set enable_bitmapscan to on;
set enable_seqscan to off;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }');
                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((collection.shard_key_value = '401'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 1 }');
                                                                                                                          QUERY PLAN                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: (collection.shard_key_value = '401'::bigint)
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(6 rows)

-- the getmore should still work and use the _id index
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }', :'r1_continuation');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   Page Row Count: 2 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ 401, { "" : 5 } ] }
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((collection.shard_key_value = '401'::bigint) AND (ROW(collection.shard_key_value, collection.object_id) > ROW('401'::bigint, '{ "" : { "$numberInt" : "5" } }'::bson)) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "getpage_batchCount" : { "$numberInt" : "2" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
(9 rows)

-- shard the collection
SELECT documentdb_api.shard_collection('{ "shardCollection": "pkcursordb.aggregation_cursor_pk", "key": { "_id": "hashed" }, "numInitialChunks": 3 }');
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- now this walks in order of shard-key THEN _id.
BEGIN;
set local enable_seqscan to on;
set local enable_indexscan to off;
set local enable_bitmapscan to off;
set local documentdb.enablePrimaryKeyCursorScan to on;
set local citus.max_adaptive_executor_pool_size to 1;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-4918719581749358852" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] }, { "table_name" : "documents_401_40005", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "6185573426042503808" }, { "" : { "$numberInt" : "9" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(5 rows)

-- continues to work with filters
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 2, "$lt": 8 } }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                      continuation                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(3 rows)

ROLLBACK;
BEGIN;
set local documentdb.enablePrimaryKeyCursorScan to on;
set local citus.max_adaptive_executor_pool_size to 1;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-4918719581749358852" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] }, { "table_name" : "documents_401_40005", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "6185573426042503808" }, { "" : { "$numberInt" : "9" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(5 rows)

-- continues to work with filters
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 2, "$lt": 8 } }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                               continuation                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } } }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(3 rows)

EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": {"sk": {"$exists": true}}, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : { "$exists" : true } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-4918719581749358852" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : { "$exists" : true } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : { "$exists" : true } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : { "$exists" : true } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] }, { "table_name" : "documents_401_40005", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "6185573426042503808" }, { "" : { "$numberInt" : "9" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(5 rows)

ROLLBACK;
-- we create a contrived scenario where we create _ids that are ~100b each and insert 1000 docs in there. This will ensure that
-- we have many pages to scan for the _id.
DO $$
DECLARE i int;
BEGIN
FOR i IN 1..1000 LOOP
PERFORM documentdb_api.insert_one('pkcursordb', 'aggregation_cursor_pk_sk2', FORMAT('{ "_id": "%s%s%s", "sk": "skval", "a": "aval", "c": [ "c", "d" ] }', CASE WHEN i >= 10 AND i < 100 THEN '0' WHEN i < 10 THEN '00' ELSE '' END, i, repeat('a', 100))::documentdb_core.bson);
END LOOP;
END;
$$;
NOTICE:  creating collection
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002", "$lt": "015" } }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
-- run the query once, this also fills the buffers and validates the index qual
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
   Page Row Count: 4 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_402_40007", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ 402, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }
   ->  Index Scan using _id_ on documents_402_40007 collection (actual rows=5 loops=1)
         Index Cond: ((shard_key_value = '402'::bigint) AND (ROW(shard_key_value, object_id) > ROW('402'::bigint, '{ "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }'::bson)) AND (object_id > '{ "" : "002" }'::bson) AND (object_id < '{ "" : {  } }'::bson) AND (object_id < '{ "" : "015" }'::bson) AND (object_id >= '{ "" : "" }'::bson))
         Filter: documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40007", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "402" }, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
(7 rows)

-- now rerun with buffers on (there should be no I/O but it should only load as many index pages as we want rows in the shared hit)
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS ON, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
   Page Row Count: 4 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_402_40007", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ 402, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }
   Buffers: shared hit=3
   ->  Index Scan using _id_ on documents_402_40007 collection (actual rows=5 loops=1)
         Index Cond: ((shard_key_value = '402'::bigint) AND (ROW(shard_key_value, object_id) > ROW('402'::bigint, '{ "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }'::bson)) AND (object_id > '{ "" : "002" }'::bson) AND (object_id < '{ "" : {  } }'::bson) AND (object_id < '{ "" : "015" }'::bson) AND (object_id >= '{ "" : "" }'::bson))
         Filter: documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40007", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "402" }, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
         Buffers: shared hit=3
(9 rows)

-- let's shard and now test with different combinations where we the shard key is on the primary key index and where it is not, or a compound shard key with _id + another field.
SELECT documentdb_api.shard_collection('{ "shardCollection": "pkcursordb.aggregation_cursor_pk_sk2", "key": { "_id": "hashed" }, "numInitialChunks": 5 }');
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
set citus.propagate_set_commands to 'local';
set local citus.max_adaptive_executor_pool_size to 1;
set local citus.enable_local_execution to off;
set local citus.explain_analyze_sort_method to taskId;
set local documentdb.enablePrimaryKeyCursorScan to on;
-- shard key is _id so range queries should still do bitmap heap scan on the RUM index since we don't have a shard_key filter.
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002", "$lt": "015" } }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SHOW documentdb.enablePrimaryKeyCursorScan;
 documentdb.enablePrimaryKeyCursorScan 
---------------------------------------------------------------------
 on
(1 row)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002", "$lt": "015" }}, "batchSize": 2 }');
                                                                                                 QUERY PLAN                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=13 loops=1)
   Task Count: 5
   Tuple data received from nodes: 2301 bytes
   Tasks Shown: One of 5
   ->  Task
         Tuple data received from node: 354 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=2 loops=1)
               ->  Bitmap Heap Scan on documents_402_40009 collection (actual rows=2 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
                     Filter: documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson)
                     Heap Blocks: exact=1
                     ->  Bitmap Index Scan on _id_ (actual rows=2 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
(14 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=9 loops=1)
   Task Count: 5
   Tuple data received from nodes: 1593 bytes
   Tasks Shown: One of 5
   ->  Task
         Tuple data received from node: 0 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=0 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } }
               ->  Bitmap Heap Scan on documents_402_40009 collection (actual rows=2 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
                     Filter: documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson)
                     Heap Blocks: exact=1
                     ->  Bitmap Index Scan on _id_ (actual rows=2 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
(17 rows)

-- equality on another field that doesn't have an index should use pk index scan
EXECUTE drain_find_query_continuation('{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": "skval" }, "batchSize": 1 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 500 }');
                                      bson_dollar_project                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
---------------------------------------------------------------------
 { "firstBatchLength" : { "$numberInt" : "1" }, "nextBatchLength" : { "$numberInt" : "0" } }   | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk_sk2", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : "skval" }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAIAAcA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-9212320495707116076" }, { "" : "938aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "firstBatchLength" : { "$numberInt" : "0" }, "nextBatchLength" : { "$numberInt" : "500" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk_sk2", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : "skval" }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAEABQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "9132621845241844623" }, { "" : "547aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }, { "table_name" : "documents_402_40010", "value" : { "$binary" : { "base64" : "AAAEAAkA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "9219976932034754998" }, { "" : "495aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }, { "table_name" : "documents_402_40011", "value" : { "$binary" : { "base64" : "AAADAA4A", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-1984388253010128201" }, { "" : "451aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "firstBatchLength" : { "$numberInt" : "0" }, "nextBatchLength" : { "$numberInt" : "499" } } | 
(3 rows)

DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }') as cp, continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": "skval" }, "batchSize": 3  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SELECT cp, continuation FROM firstPageResponse;
                                                                                                                                                                                                                         cp                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                   continuation                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "firstBatch" : [ { "_id" : "938aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }, { "_id" : "561aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }, { "_id" : "619aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk_sk2", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "sk" : "skval" }, "batchSize" : { "$numberInt" : "3" } }, "continuation" : [ { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAFAA0A", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-9166445935549971268" }, { "" : "619aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
(1 row)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": "skval" },  "batchSize": 1 }');
                                                                                               QUERY PLAN                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=1000 loops=1)
   Task Count: 5
   Tuple data received from nodes: 308 kB
   Tasks Shown: One of 5
   ->  Task
         Tuple data received from node: 65 kB
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=210 loops=1)
               ->  Index Scan using _id_ on documents_402_40009 collection (actual rows=210 loops=1)
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson))
(10 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=20 loops=1)
   Task Count: 5
   Tuple data received from nodes: 6300 bytes
   Tasks Shown: One of 5
   ->  Task
         Tuple data received from node: 1260 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAFAA0A", "subType" : "00" } }, "pk" : [ -9166445935549971268, { "" : "619aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }
               ->  Index Scan using _id_ on documents_402_40009 collection (actual rows=5 loops=1)
                     Index Cond: (ROW(shard_key_value, object_id) > ROW('-9166445935549971268'::bigint, '{ "" : "619aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }'::documentdb_core.bson))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40009", "value" : { "$binary" : { "base64" : "AAAFAA0A", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-9166445935549971268" }, { "" : "619aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(14 rows)

-- TODO: optimization, $in on shard_key could also use primary key index.
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$in":  [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ]} }, "batchSize": 1  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$in":  [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ]}}, "batchSize": 1 }');
                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=2 loops=1)
   Task Count: 2
   Tuple data received from nodes: 354 bytes
   Tasks Shown: One of 2
   ->  Task
         Tuple data received from node: 177 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=1 loops=1)
               ->  Bitmap Heap Scan on documents_402_40013 collection (actual rows=1 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "_id" : [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ] }'::documentdb_core.bson)
                     Filter: ((object_id OPERATOR(documentdb_core.=) ANY ('{"{ \"\" : \"003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" }","{ \"\" : \"002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" }"}'::documentdb_core.bson[])) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson) AND ((shard_key_value = '-8689222912922845676'::bigint) OR (shard_key_value = '-1683133392141199226'::bigint)))
                     Heap Blocks: exact=1
                     ->  Bitmap Index Scan on _id_ (actual rows=1 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "_id" : [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ] }'::documentdb_core.bson)
(14 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=1 loops=1)
   Task Count: 2
   Tuple data received from nodes: 177 bytes
   Tasks Shown: One of 2
   ->  Task
         Tuple data received from node: 177 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=1 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               ->  Bitmap Heap Scan on documents_402_40013 collection (actual rows=1 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "_id" : [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ] }'::documentdb_core.bson)
                     Filter: ((object_id OPERATOR(documentdb_core.=) ANY ('{"{ \"\" : \"003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" }","{ \"\" : \"002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" }"}'::documentdb_core.bson[])) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40011", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND ((shard_key_value = '-8689222912922845676'::bigint) OR (shard_key_value = '-1683133392141199226'::bigint)))
                     Heap Blocks: exact=1
                     ->  Bitmap Index Scan on _id_ (actual rows=1 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@*=) '{ "_id" : [ "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" ] }'::documentdb_core.bson)
(16 rows)

END;
-- unshard and shard with a shard key that is not the primary key
SELECT documentdb_api.unshard_collection('{"unshardCollection": "pkcursordb.aggregation_cursor_pk_sk2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('{ "shardCollection": "pkcursordb.aggregation_cursor_pk_sk2", "key": { "sk": "hashed" }, "numInitialChunks": 5 }');
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
set citus.propagate_set_commands to 'local';
set local citus.max_adaptive_executor_pool_size to 1;
set local citus.enable_local_execution to off;
set local citus.explain_analyze_sort_method to taskId;
set local documentdb.enablePrimaryKeyCursorScan to on;
-- range queries on _id with shard_key equality should use pk index scan
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002" }, "sk": "skval" }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002" }, "sk": "skval" }, "batchSize": 2 }');
                                                                                                                        QUERY PLAN                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=999 loops=1)
   Task Count: 1
   Tuple data received from nodes: 307 kB
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 307 kB
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=999 loops=1)
               ->  Index Scan using _id_ on documents_402_40019 collection (actual rows=999 loops=1)
                     Index Cond: ((shard_key_value = '5502411283078044214'::bigint) AND (object_id OPERATOR(documentdb_core.>) '{ "" : "002" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : {  } }'::documentdb_core.bson))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson))
(11 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=4 loops=1)
   Task Count: 1
   Tuple data received from nodes: 1260 bytes
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 1260 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAiAAUA", "subType" : "00" } }, "pk" : [ 5502411283078044214, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }
               ->  Index Scan using _id_ on documents_402_40019 collection (actual rows=5 loops=1)
                     Index Cond: ((shard_key_value = '5502411283078044214'::bigint) AND (ROW(shard_key_value, object_id) > ROW('5502411283078044214'::bigint, '{ "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }'::documentdb_core.bson)) AND (object_id OPERATOR(documentdb_core.>) '{ "" : "002" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : {  } }'::documentdb_core.bson))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAiAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "5502411283078044214" }, { "" : "003aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(14 rows)

-- test draining the query
EXECUTE drain_find_query_continuation('{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002" }, "sk": "skval" }, "batchSize": 1 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 500 }');
                                      bson_dollar_project                                      |                                                                                                                                                                                                                                                                                                                                             continuation                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "firstBatchLength" : { "$numberInt" : "1" }, "nextBatchLength" : { "$numberInt" : "0" } }   | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk_sk2", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : "002" }, "sk" : "skval" }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAASAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "5502411283078044214" }, { "" : "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "firstBatchLength" : { "$numberInt" : "0" }, "nextBatchLength" : { "$numberInt" : "500" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk_sk2", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : "002" }, "sk" : "skval" }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAVABcA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "5502411283078044214" }, { "" : "501aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "firstBatchLength" : { "$numberInt" : "0" }, "nextBatchLength" : { "$numberInt" : "498" } } | 
(3 rows)

-- TODO: optimization, range queries on _id + shard_key_filter should also use primary key index, it currently uses the RUM _id index with the @<> range operator.
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002", "$lt": "015" }, "sk": "skval" }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": "002", "$lt": "015" }, "sk": "skval" }, "batchSize": 2 }');
                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=13 loops=1)
   Task Count: 1
   Tuple data received from nodes: 2301 bytes
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 2301 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=13 loops=1)
               ->  Bitmap Heap Scan on documents_402_40019 collection (actual rows=13 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.>) '{ "" : "002" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : {  } }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : "015" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.>=) '{ "" : "" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson) AND (shard_key_value = '5502411283078044214'::bigint))
                     Heap Blocks: exact=5
                     ->  Bitmap Index Scan on _id_ (actual rows=13 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
(14 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=4 loops=1)
   Task Count: 1
   Tuple data received from nodes: 708 bytes
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 708 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } }
               ->  Bitmap Heap Scan on documents_402_40019 collection (actual rows=7 loops=1)
                     Recheck Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.>) '{ "" : "002" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : {  } }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.<) '{ "" : "015" }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.>=) '{ "" : "" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson) AND (shard_key_value = '5502411283078044214'::bigint))
                     Heap Blocks: exact=4
                     ->  Bitmap Index Scan on _id_ (actual rows=13 loops=1)
                           Index Cond: (document OPERATOR(documentdb_api_catalog.@<>) '{ "_id" : { "min" : "002", "max" : "015", "minInclusive" : false, "maxInclusive" : false } }'::documentdb_core.bson)
(17 rows)

-- equality on the shard key since we don't have an index on it should do primary key scan
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": "skval" }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": "skval" }, "batchSize": 2 }');
                                                                                               QUERY PLAN                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=1000 loops=1)
   Task Count: 1
   Tuple data received from nodes: 308 kB
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 308 kB
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=1000 loops=1)
               ->  Index Scan using _id_ on documents_402_40019 collection (actual rows=1000 loops=1)
                     Index Cond: (shard_key_value = '5502411283078044214'::bigint)
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson))
(11 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=4 loops=1)
   Task Count: 1
   Tuple data received from nodes: 1260 bytes
   Tasks Shown: All
   ->  Task
         Tuple data received from node: 1260 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAASAAIA", "subType" : "00" } }, "pk" : [ 5502411283078044214, { "" : "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] }
               ->  Index Scan using _id_ on documents_402_40019 collection (actual rows=5 loops=1)
                     Index Cond: ((shard_key_value = '5502411283078044214'::bigint) AND (ROW(shard_key_value, object_id) > ROW('5502411283078044214'::bigint, '{ "" : "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }'::documentdb_core.bson)))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "sk" : "skval" }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAASAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "5502411283078044214" }, { "" : "002aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } ] } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson))
(14 rows)

-- TODO: optimization, $in on shard_key could also use primary key index instead of bitmap scan on RUM.
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": { "$in": [ "skval", "skval2", "skval3" ] } }, "batchSize": 2  }', cursorId => 4294967294);
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk_sk2", "projection": { "_id": 1 }, "filter": { "sk": { "$in": [ "skval", "skval2", "skval3" ] } }, "batchSize": 2 }');
                                                                                                            QUERY PLAN                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=1000 loops=1)
   Task Count: 2
   Tuple data received from nodes: 173 kB
   Tasks Shown: One of 2
   ->  Task
         Tuple data received from node: 173 kB
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=1000 loops=1)
               ->  Bitmap Heap Scan on documents_402_40019 collection (actual rows=1000 loops=1)
                     Recheck Cond: ((shard_key_value = '5502411283078044214'::bigint) OR (shard_key_value = '-8977384915789703169'::bigint) OR (shard_key_value = '1024044587770450461'::bigint))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "sk" : [ "skval", "skval2", "skval3" ] }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ }'::documentdb_core.bson))
                     Heap Blocks: exact=42
                     ->  BitmapOr (actual rows=0 loops=1)
                           ->  Bitmap Index Scan on _id_ (actual rows=1000 loops=1)
                                 Index Cond: (shard_key_value = '5502411283078044214'::bigint)
                           ->  Bitmap Index Scan on _id_ (actual rows=0 loops=1)
                                 Index Cond: (shard_key_value = '-8977384915789703169'::bigint)
                           ->  Bitmap Index Scan on _id_ (actual rows=0 loops=1)
                                 Index Cond: (shard_key_value = '1024044587770450461'::bigint)
(19 rows)

EXPLAIN (VERBOSE OFF, COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk_sk2", "batchSize": 2 }', :'r1_continuation');
                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive) (actual rows=4 loops=1)
   Task Count: 2
   Tuple data received from nodes: 708 bytes
   Tasks Shown: One of 2
   ->  Task
         Tuple data received from node: 708 bytes
         Node: host=localhost port=58070 dbname=regression
         ->  Custom Scan (DocumentDBApiScan) (actual rows=4 loops=1)
               Page Row Count: 4 rows
               Page Size Hint: 16777216 bytes
               Continuation: { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } }
               ->  Bitmap Heap Scan on documents_402_40019 collection (actual rows=7 loops=1)
                     Recheck Cond: ((shard_key_value = '5502411283078044214'::bigint) OR (shard_key_value = '-8977384915789703169'::bigint) OR (shard_key_value = '1024044587770450461'::bigint))
                     Filter: ((document OPERATOR(documentdb_api_catalog.@*=) '{ "sk" : [ "skval", "skval2", "skval3" ] }'::documentdb_core.bson) AND documentdb_api_internal.cursor_state(document, '{ "continuation" : [ { "table_name" : "documents_402_40019", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "getpage_batchCount" : { "$numberInt" : "4" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::documentdb_core.bson))
                     Heap Blocks: exact=1
                     ->  BitmapOr (actual rows=0 loops=1)
                           ->  Bitmap Index Scan on _id_ (actual rows=1000 loops=1)
                                 Index Cond: (shard_key_value = '5502411283078044214'::bigint)
                           ->  Bitmap Index Scan on _id_ (actual rows=0 loops=1)
                                 Index Cond: (shard_key_value = '-8977384915789703169'::bigint)
                           ->  Bitmap Index Scan on _id_ (actual rows=0 loops=1)
                                 Index Cond: (shard_key_value = '1024044587770450461'::bigint)
(22 rows)

END;

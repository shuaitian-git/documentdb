SET search_path TO documentdb_api,documentdb_core;
SET documentdb.next_collection_id TO 9200;
SET documentdb.next_collection_index_id TO 9200;
SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 1, "userName" : "Sam" }');
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 2, "userName" : "Alex", "friend" : "Sam" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 3, "userName" : "Jamie", "friend" : "Alex" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 4, "userName" : "Taylor", "friend" : "Alex" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 5, "userName" : "Morgan", "friend" : "Jamie" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_socialgroup', '{ "_id" : 6, "userName" : "Jordan", "friend" : "Taylor" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_socialgroup", "pipeline": [ { "$graphLookup": { "from": "graphlookup_socialgroup", "startWith": "$friend", "connectFromField": "friend", "connectToField": "userName", "as": "friendChain" } } ]}');
                                                                                                                                                      document                                                                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "friendChain" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" } ] }
 { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }
 { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }
 { "_id" : { "$numberInt" : "5" }, "userName" : "Morgan", "friend" : "Jamie", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex" } ] }
 { "_id" : { "$numberInt" : "6" }, "userName" : "Jordan", "friend" : "Taylor", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex" } ] }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_socialgroup", "pipeline": [ { "$graphLookup": { "from": "graphlookup_socialgroup", "startWith": "$friend", "connectFromField": "friend", "connectToField": "userName", "as": "friendChain" } } ]}');
                                                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documentdb_data.documents_9200 collection
   Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "friendChain" : [  ] }'::bson), true)
   Recheck Cond: (collection.shard_key_value = '9200'::bigint)
   ->  Bitmap Index Scan on _id_
         Index Cond: (collection.shard_key_value = '9200'::bigint)
   SubPlan 2
     ->  Aggregate
           Output: COALESCE(documentdb_api_catalog.bson_array_agg("graphLookup_stage_2".document, 'friendChain'::text), '{ "friendChain" : [  ] }'::bson)
           ->  Unique
                 Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                 CTE graphLookupRecurseStage
                   ->  Recursive Union
                         ->  Bitmap Heap Scan on documentdb_data.documents_9200 collection_0_2
                               Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false))]
                               Recheck Cond: (collection_0_2.shard_key_value = '9200'::bigint)
                               Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "userName" : { "$makeArray" : "$friend" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'userName'::text)
                               ->  Bitmap Index Scan on _id_
                                     Index Cond: (collection_0_2.shard_key_value = '9200'::bigint)
                         ->  Nested Loop
                               Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false))])
                               Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "userName" : { "$makeArray" : "$friend" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'userName'::text)
                               ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                     Output: "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1".path, "lookupRecursive_stage_1".document
                                     Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                               ->  Materialize
                                     Output: collection_0_2_1.document
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9200 collection_0_2_1
                                           Output: collection_0_2_1.document
                                           Recheck Cond: (collection_0_2_1.shard_key_value = '9200'::bigint)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2_1.shard_key_value = '9200'::bigint)
                 ->  Sort
                       Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                             Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(36 rows)

SELECT documentdb_api.insert_one('db', 'graphlookup_places', '{ "_id" : 0, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }');
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_places', '{ "_id" : 1, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_places', '{ "_id" : 2, "placeCode" : "P3", "nearby" : [ "P1" ] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_places', '{ "_id" : 3, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_places', '{ "_id" : 4, "placeCode" : "P5", "nearby" : [ "P4" ] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_visitors', '{ "_id" : 1, "userName" : "Sam", "homePlace" : "P1" }');
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_visitors', '{ "_id" : 2, "userName" : "Alex", "homePlace" : "P1" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'graphlookup_visitors', '{ "_id" : 3, "userName" : "Jamie", "homePlace" : "P2" }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] } ] }
 { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] } ] }
 { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "homePlace" : "P2", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] }, { "_id" : { "$numberInt" : "4" }, "placeCode" : "P5", "nearby" : [ "P4" ] } ] }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documentdb_data.documents_9202 collection
   Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "reachablePlaces" : [  ] }'::bson), true)
   Recheck Cond: (collection.shard_key_value = '9202'::bigint)
   ->  Bitmap Index Scan on _id_
         Index Cond: (collection.shard_key_value = '9202'::bigint)
   SubPlan 2
     ->  Aggregate
           Output: COALESCE(documentdb_api_catalog.bson_array_agg("graphLookup_stage_2".document, 'reachablePlaces'::text), '{ "reachablePlaces" : [  ] }'::bson)
           ->  Unique
                 Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                 CTE graphLookupRecurseStage
                   ->  Recursive Union
                         ->  Bitmap Heap Scan on documentdb_data.documents_9201 collection_0_2
                               Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false))]
                               Recheck Cond: (collection_0_2.shard_key_value = '9201'::bigint)
                               Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "placeCode" : { "$makeArray" : "$homePlace" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'placeCode'::text)
                               ->  Bitmap Index Scan on _id_
                                     Index Cond: (collection_0_2.shard_key_value = '9201'::bigint)
                         ->  Nested Loop
                               Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false))])
                               Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "placeCode" : { "$makeArray" : "$nearby" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'placeCode'::text)
                               ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                     Output: "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1".path, "lookupRecursive_stage_1".document
                                     Filter: ((NOT "lookupRecursive_stage_1".is_cycle) AND ("lookupRecursive_stage_1".depth OPERATOR(documentdb_api_catalog.#<) '{ "depth" : { "$numberInt" : "2" } }'::bsonquery))
                               ->  Materialize
                                     Output: collection_0_2_1.document
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9201 collection_0_2_1
                                           Output: collection_0_2_1.document
                                           Recheck Cond: (collection_0_2_1.shard_key_value = '9201'::bigint)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2_1.shard_key_value = '9201'::bigint)
                 ->  Sort
                       Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                             Output: "graphLookup_stage_2".document, "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(36 rows)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "depthField": "stepsCount" } } ]}');
                                                                                                                                                                                                                                                                                                                                                          document                                                                                                                                                                                                                                                                                                                                                          
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ], "stepsCount" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ], "stepsCount" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "4" }, "placeCode" : "P5", "nearby" : [ "P4" ], "stepsCount" : { "$numberInt" : "3" } } ] }
 { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ], "stepsCount" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ], "stepsCount" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "4" }, "placeCode" : "P5", "nearby" : [ "P4" ], "stepsCount" : { "$numberInt" : "3" } } ] }
 { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "homePlace" : "P2", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ], "stepsCount" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ], "stepsCount" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ], "stepsCount" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "4" }, "placeCode" : "P5", "nearby" : [ "P4" ], "stepsCount" : { "$numberInt" : "2" } } ] }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "depthField": "stepsCount" } } ]}');
                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documentdb_data.documents_9202 collection
   Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "reachablePlaces" : [  ] }'::bson), true)
   Recheck Cond: (collection.shard_key_value = '9202'::bigint)
   ->  Bitmap Index Scan on _id_
         Index Cond: (collection.shard_key_value = '9202'::bigint)
   SubPlan 2
     ->  Aggregate
           Output: COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), 'reachablePlaces'::text), '{ "reachablePlaces" : [  ] }'::bson)
           ->  Unique
                 Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                 CTE graphLookupRecurseStage
                   ->  Recursive Union
                         ->  Bitmap Heap Scan on documentdb_data.documents_9201 collection_0_2
                               Output: collection_0_2.document, '{ "stepsCount" : { "$numberInt" : "0" } }'::bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::bson, false))]
                               Recheck Cond: (collection_0_2.shard_key_value = '9201'::bigint)
                               Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "placeCode" : { "$makeArray" : "$homePlace" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'placeCode'::text)
                               ->  Bitmap Index Scan on _id_
                                     Index Cond: (collection_0_2.shard_key_value = '9201'::bigint)
                         ->  Nested Loop
                               Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "stepsCount" : { "$add" : [ "$stepsCount", { "$numberInt" : "1" } ] } }'::bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::bson, false))])
                               Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "placeCode" : { "$makeArray" : "$nearby" } }'::bson, false, '{ "now" : NOW_SYS_VARIABLE }'::bson), 'placeCode'::text)
                               ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                     Output: "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1".path, "lookupRecursive_stage_1".document
                                     Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                               ->  Materialize
                                     Output: collection_0_2_1.document
                                     ->  Bitmap Heap Scan on documentdb_data.documents_9201 collection_0_2_1
                                           Output: collection_0_2_1.document
                                           Recheck Cond: (collection_0_2_1.shard_key_value = '9201'::bigint)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2_1.shard_key_value = '9201'::bigint)
                 ->  Sort
                       Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                       ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                             Output: documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(36 rows)

-- $graphLookup inside $facet
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_socialgroup", "pipeline": [ { "$facet": { "inner": [ { "$graphLookup": { "from": "graphlookup_socialgroup", "startWith": "$friend", "connectFromField": "friend", "connectToField": "userName", "as": "friendChain" } } ] } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "inner" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "friendChain" : [  ] }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" } ] }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "5" }, "userName" : "Morgan", "friend" : "Jamie", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex" } ] }, { "_id" : { "$numberInt" : "6" }, "userName" : "Jordan", "friend" : "Taylor", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex" } ] } ] }
(1 row)

-- $graphLookup inside $lookup
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$lookup": { "from": "graphlookup_socialgroup", "as": "inner", "pipeline": [ { "$graphLookup": { "from": "graphlookup_socialgroup", "startWith": "$friend", "connectFromField": "friend", "connectToField": "userName", "as": "friendChain" } } ] } } ]}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "homePlace" : "P1", "inner" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "friendChain" : [  ] }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" } ] }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "5" }, "userName" : "Morgan", "friend" : "Jamie", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex" } ] }, { "_id" : { "$numberInt" : "6" }, "userName" : "Jordan", "friend" : "Taylor", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex" } ] } ] }
 { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "homePlace" : "P1", "inner" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "friendChain" : [  ] }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" } ] }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "5" }, "userName" : "Morgan", "friend" : "Jamie", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex" } ] }, { "_id" : { "$numberInt" : "6" }, "userName" : "Jordan", "friend" : "Taylor", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex" } ] } ] }
 { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "homePlace" : "P2", "inner" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "friendChain" : [  ] }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" } ] }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" } ] }, { "_id" : { "$numberInt" : "5" }, "userName" : "Morgan", "friend" : "Jamie", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "friend" : "Alex" } ] }, { "_id" : { "$numberInt" : "6" }, "userName" : "Jordan", "friend" : "Taylor", "friendChain" : [ { "_id" : { "$numberInt" : "1" }, "userName" : "Sam" }, { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "friend" : "Sam" }, { "_id" : { "$numberInt" : "4" }, "userName" : "Taylor", "friend" : "Alex" } ] } ] }
(3 rows)

-- source can be sharded
SELECT documentdb_api.shard_collection('db', 'graphlookup_visitors', '{ "_id": "hashed" }', false);
 shard_collection 
------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "maxDepth": 2 } } ]}');
                                                                                                                                                                                                                                                        document                                                                                                                                                                                                                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "userName" : "Sam", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] } ] }
 { "_id" : { "$numberInt" : "2" }, "userName" : "Alex", "homePlace" : "P1", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] } ] }
 { "_id" : { "$numberInt" : "3" }, "userName" : "Jamie", "homePlace" : "P2", "reachablePlaces" : [ { "_id" : { "$numberInt" : "0" }, "placeCode" : "P1", "nearby" : [ "P2", "P3" ] }, { "_id" : { "$numberInt" : "1" }, "placeCode" : "P2", "nearby" : [ "P1", "P4" ] }, { "_id" : { "$numberInt" : "2" }, "placeCode" : "P3", "nearby" : [ "P1" ] }, { "_id" : { "$numberInt" : "3" }, "placeCode" : "P4", "nearby" : [ "P2", "P5" ] }, { "_id" : { "$numberInt" : "4" }, "placeCode" : "P5", "nearby" : [ "P4" ] } ] }
(3 rows)

-- target cannot be sharded
SELECT documentdb_api.shard_collection('db', 'graphlookup_places', '{ "_id": "hashed" }', false);
 shard_collection 
------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db', 'graphlookup_socialgroup', '{ "_id": "hashed" }', false);
 shard_collection 
------------------
 
(1 row)

SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_socialgroup", "pipeline": [ { "$graphLookup": { "from": "graphlookup_socialgroup", "startWith": "$friend", "connectFromField": "friend", "connectToField": "userName", "as": "friendChain" } } ]}');
ERROR:  $graphLookup using 'from' on a sharded collection is currently unsupported
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "graphlookup_visitors", "pipeline": [ { "$graphLookup": { "from": "graphlookup_places", "startWith": "$homePlace", "connectFromField": "nearby", "connectToField": "placeCode", "as": "reachablePlaces", "maxDepth": 2 } } ]}');
ERROR:  $graphLookup using 'from' on a sharded collection is currently unsupported

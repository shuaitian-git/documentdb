SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET documentdb.next_collection_id TO 780000;
SET documentdb.next_collection_index_id TO 780000;
--Test without Enabling feature flag of $merge
SELECT documentdb_api.insert_one('sourceDB','withoutFlag',' { "_id" :  1, "country" : "India", "state" : "Rajasthan", "Code" : "RJ03" }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('sourceDB', '{ "aggregate": "withoutFlag", "pipeline": [ {"$merge" : { "into": "targetwithoutFlag" }} ] , "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "sourceDB.withoutFlag", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

--Test without Enabling flag for $merge stage target collection creation 
SELECT * FROM aggregate_cursor_first_page('sourceDB', '{ "aggregate": "withoutFlag", "pipeline": [ {"$merge" : { "into": "targetwithoutFlag" }} ] , "cursor": { "batchSize": 1 } }', 4294967294);
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "sourceDB.withoutFlag", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

-- custom udf testing
SELECT * FROM documentdb_api_internal.bson_dollar_merge_add_object_id('{"_id" :  1, "a" : 1}', documentdb_api_internal.bson_dollar_merge_generate_object_id('{"a" : "dummy bson"}'));
                 bson_dollar_merge_add_object_id                  
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_add_object_id('{"a" : 1, "_id" :  1}', documentdb_api_internal.bson_dollar_merge_generate_object_id('{"a" : "dummy bson"}'));
                 bson_dollar_merge_add_object_id                  
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" } }
(1 row)

SELECT count(*) FROM documentdb_api_internal.bson_dollar_merge_generate_object_id('{"a" : "dummy bson"}');
 count 
-------
     1
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : 1, "b" : 2}', documentdb_api_internal.bson_dollar_extract_merge_filter('{"a" : 1, "b" : 3}', 'a'::TEXT), 'a'::TEXT);
 bson_dollar_merge_join 
------------------------
 t
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : 1, "b" : 2}', documentdb_api_internal.bson_dollar_extract_merge_filter('{"a" : 2, "b" : 2}', 'a'::TEXT), 'a'::TEXT);
 bson_dollar_merge_join 
------------------------
 f
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : {"b" : 1 }, "c" : 2}', '{"a" : {"b" : 1}}', 'a.b'::TEXT);
 bson_dollar_merge_join 
------------------------
 t
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : {"b" : 1 }, "c" : 2}', '{"a" : {"b" : 2}}', 'a.b'::TEXT);
 bson_dollar_merge_join 
------------------------
 f
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : [1,2,3], "c" : 2}', '{"a" : 2}', 'a'::TEXT);
 bson_dollar_merge_join 
------------------------
 t
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : [1,2,3], "c" : 2}', '{"a" : 4}', 'a'::TEXT);
 bson_dollar_merge_join 
------------------------
 f
(1 row)

SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : 1, "b" : 2}', documentdb_api_internal.bson_dollar_extract_merge_filter('{"a" : [1,2,3], "b" : 3}','a'::TEXT), 'a'::TEXT);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : 1, "b" : 2}',  documentdb_api_internal.bson_dollar_extract_merge_filter('{"b" : 3}', 'a'::TEXT), 'a'::TEXT);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM documentdb_api_internal.bson_dollar_merge_join('{"a" : 1, "b" : 2}',  documentdb_api_internal.bson_dollar_extract_merge_filter('{"a" : null}','a' ::TEXT), 'a'::TEXT);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM documentdb_api_internal.bson_dollar_merge_fail_when_not_matched('{"a" : "this is a dummy bson"}', 'this is dummy text'::TEXT);
ERROR:  $merge failed to locate a corresponding document in the target collection for one or more documents from the source collection
--  Merge with default option
SELECT documentdb_api.insert_one('defDb','defSrc',' { "_id" :  1, "a" : 1 }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('defDb','defSrc',' { "_id" :  2, "a" : 2 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('defDb','defTar',' { "_id" :  1, "b" : 2 }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('defDb', '{ "aggregate": "defSrc", "pipeline": [  {"$merge" : { "into": "defTar" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                            cursorpage                                                             | continuation | persistconnection | cursorid 
-----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "defDb.defSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('defDb', 'defTar');
                                            document                                            
------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" } }
(2 rows)

-- simplest test case working
SELECT documentdb_api.insert('db', '{"insert":"moviesDB", "documents":[
   { "_id" : 1, "movie": "Iron Man 3", "Budget": 180000000, "year": 2011 },
   { "_id" : 2, "movie": "Captain America the winter soldier", "Budget": 170000000, "year": 2011 },
   { "_id" : 3, "movie": "Aveneger Endgame", "Budget": 160000000, "year": 2012 },
   { "_id" : 4, "movie": "Spider Man", "Budget": 150000000, "year": 2012 },
   { "_id" : 5, "movie": "Iron Man 2", "Budget": 140000000, "year": 2013 },
   { "_id" : 6, "movie": "Iron Man 1", "Budget": 130000000, "year": 2013 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "moviesDB", "pipeline": [  {"$merge" : { "into": "budgets" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                            cursorpage                                                            | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.moviesDB", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'budgets');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

-- simple test case target database is not same as source database
SELECT documentdb_api.insert_one('sourceDB','sourceDumpData',' { "_id" :  1, "country" : "India", "state" : "Rajasthan", "Code" : "RJ03" }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('sourceDB', '{ "aggregate": "sourceDumpData", "pipeline": [ {"$merge" : { "into": {"db" : "targetDB" , "coll" : "targetDumpData"}, "on" : "_id", "whenMatched" : "replace" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                  cursorpage                                                                  | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "sourceDB.sourceDumpData", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('targetDB', 'targetDumpData');
                                            document                                             
-------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "country" : "India", "state" : "Rajasthan", "Code" : "RJ03" }
(1 row)

-- object id missing test
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "moviesDB", "pipeline": [ {"$project" : {"_id" : 0}}, {"$merge" : { "into": "budgets2" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                            cursorpage                                                            | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.moviesDB", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT count(document) FROM documentdb_api.collection('db', 'budgets2');
 count 
-------
     6
(1 row)

-- test when merge input is string 
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "moviesDB", "pipeline": [ {"$merge" : "normalString" } ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                            cursorpage                                                            | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.moviesDB", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "moviesDB", "pipeline": [ {"$merge" : "dotted.String" } ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                            cursorpage                                                            | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.moviesDB", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','normalString');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

SELECT document FROM documentdb_api.collection('db', 'dotted.String');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

-- unique index test
SELECT documentdb_api.insert_one('db','uniqueIndexTestSrc',' { "_id" :  10, "a" : 1, "b" : 1, "c" : 1 , "d" : 1, "e" : 1, "f" : 1}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "uniqueIndexTestTarget", "indexes": [{"key": {"a": 1, "b" : 1, "c" :1}, "name": "index_1", "unique" : true}]}', true);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "uniqueIndexTestTarget", "indexes": [{"key": {"a": 1}, "name": "index_2", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "2" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "uniqueIndexTestTarget", "indexes": [{"key": {"e": 1}, "name": "index_3", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "3" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "uniqueIndexTestTarget", "indexes": [{"key": {"f": 1}, "name": "index_4", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "4" }, "numIndexesAfter" : { "$numberInt" : "5" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "uniqueIndexTestSrc", "pipeline": [ {"$merge" : { "on" : ["b" , "c" , "a"],"into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                 | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.uniqueIndexTestSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "uniqueIndexTestSrc", "pipeline": [ {"$merge" : { "on" : ["c" , "b" , "a"],"into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                 | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.uniqueIndexTestSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "uniqueIndexTestSrc", "pipeline": [ {"$merge" : { "on" : "_id", "into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                 | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.uniqueIndexTestSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "uniqueIndexTestSrc", "pipeline": [ {"$merge" : { "into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                 | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.uniqueIndexTestSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "uniqueIndexTestSrc", "pipeline": [ {"$merge" : { "on" : ["_id"], "into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                 | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.uniqueIndexTestSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'uniqueIndexTestTarget');
                                                                                                        document                                                                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "1" }, "d" : { "$numberInt" : "1" }, "e" : { "$numberInt" : "1" }, "f" : { "$numberInt" : "1" } }
(1 row)

-- _id unique index test
SELECT documentdb_api.insert_one('db','objectIDUniqueIndex',' { "_id" :  10, "a" : 1, "b" : 1, "c" : 1 , "d" : 1, "e" : 1, "f" : 1, "field1" : 1, "field2" : 2}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "uniqueIndexTestTarget", "indexes": [{"key": {"field1": 1, "field2" : 1, "_id" : 1}, "name": "index_id", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "5" }, "numIndexesAfter" : { "$numberInt" : "6" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDUniqueIndex", "pipeline": [ {"$merge" : { "on" : "_id","into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.objectIDUniqueIndex", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDUniqueIndex", "pipeline": [ {"$merge" : { "on" : ["_id"],"into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.objectIDUniqueIndex", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDUniqueIndex", "pipeline": [ {"$merge" : { "on" : ["field1","_id","field2"],"into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.objectIDUniqueIndex", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDUniqueIndex", "pipeline": [ {"$merge" : { "into": "uniqueIndexTestTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.objectIDUniqueIndex", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

--test source collection is sharded.
SELECT documentdb_api.insert('db', '{"insert":"soruceShardedTest", "documents":[
   { "_id" : 1, "movie": "Iron Man 3", "Budget": 180000000, "year": 2011 },
   { "_id" : 2, "movie": "Captain America the winter soldier", "Budget": 170000000, "year": 2011 },
   { "_id" : 3, "movie": "Aveneger Endgame", "Budget": 160000000, "year": 2012 },
   { "_id" : 4, "movie": "Spider Man", "Budget": 150000000, "year": 2012 },
   { "_id" : 5, "movie": "Iron Man 2", "Budget": 140000000, "year": 2013 },
   { "_id" : 6, "movie": "Iron Man 1", "Budget": 130000000, "year": 2013 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.shard_collection('db', 'soruceShardedTest', '{ "employee": "hashed" }', false);
 shard_collection 
------------------
 
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "soruceShardedTest", "pipeline": [ {"$merge" : { "into": "soruceShardedTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.soruceShardedTest", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'soruceShardedTarget');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "soruceShardedTest", "pipeline": [{"$project" : { "_id" : 1, "employee" : 1, "Budget" : {"$add" : ["$Budget" , 1000]} }} ,{"$merge" : { "into": "soruceShardedTarget", "whenMatched" : "replace" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.soruceShardedTest", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'soruceShardedTarget');
                                   document                                    
-------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "Budget" : { "$numberInt" : "180001000" } }
 { "_id" : { "$numberInt" : "2" }, "Budget" : { "$numberInt" : "170001000" } }
 { "_id" : { "$numberInt" : "3" }, "Budget" : { "$numberInt" : "160001000" } }
 { "_id" : { "$numberInt" : "4" }, "Budget" : { "$numberInt" : "150001000" } }
 { "_id" : { "$numberInt" : "5" }, "Budget" : { "$numberInt" : "140001000" } }
 { "_id" : { "$numberInt" : "6" }, "Budget" : { "$numberInt" : "130001000" } }
(6 rows)

-- simple replace scenario
SELECT documentdb_api.insert('db', '{"insert":"sourceDataReplace", "documents":[
   { "_id" : 1, "a": 1, "b": "a" },
   { "_id" : 2, "a": 2, "b": "b" },
   { "_id" : 3, "a": 3, "b": "c" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataReplace", "documents":[
   { "_id" : 1, "a": 10 },
   { "_id" : 3, "a": 30 },
   { "_id" : 4, "a": 40 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataReplace", "pipeline": [  {"$merge": {"into": "targetDataReplace", "whenMatched": "replace", "whenNotMatched": "discard"}} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceDataReplace", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','targetDataReplace');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "a" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : "c" }
 { "_id" : { "$numberInt" : "4" }, "a" : { "$numberInt" : "40" } }
(3 rows)

-- let's create index and match on other key and try to replace _id field when source and target ID are same
SELECT documentdb_api.insert('db', '{"insert":"sourceDataReplaceId", "documents":[{ "_id" : 1, "a": 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataReplaceId", "documents":[{ "_id" : 1, "a": 10, "b" : 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataReplaceId", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataReplaceId", "pipeline": [ {"$merge" : { "into": "targetDataReplaceId", "on" : "a", "whenMatched" : "replace" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceDataReplaceId", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','targetDataReplaceId');
                             document                              
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "10" } }
(1 row)

-- let's create index and match on other key and try to replace _id field whe source and target ID's are different. 
SELECT documentdb_api.insert('db', '{"insert":"sourceDataReplaceIdDiff", "documents":[{ "_id" : 1, "a": 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataReplaceIdDiff", "documents":[{ "_id" : 2, "a": 10, "b" : 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataReplaceIdDiff", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataReplaceIdDiff", "pipeline": [ {"$merge" : { "into": "targetDataReplaceIdDiff", "on" : "a", "whenMatched" : "replace" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge could not update the target document as an immutable field (like '_id' or shardKey) was detected to be modified.
-- Now let's see what happens when we are not projecting _id from source and source _id is getting generated and if source objectID is generated then it will be not same as targets.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataReplaceIdDiff", 
"pipeline": [  {"$project" : { "_id": 0 }},
               {"$merge" : { "into": "targetDataReplaceIdDiff", "on" : "a", "whenMatched" : "replace" }} 
            ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                   cursorpage                                                                    | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceDataReplaceIdDiff", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','targetDataReplaceIdDiff');
                             document                              
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "10" } }
(1 row)

-- simple merge scenario
SELECT documentdb_api.insert('db', '{"insert":"sourceWhenMatchMerge", "documents":[
   { "_id" : 1, "movie": "Iron Man 3", "Budget": 180000000, "year": 2011 },
   { "_id" : 2, "movie": "Captain America the winter soldier", "Budget": 170000000, "year": 2011 },
   { "_id" : 3, "movie": "Aveneger Endgame", "Budget": 160000000, "year": 2012 },
   { "_id" : 4, "movie": "Spider Man", "Budget": 150000000, "year": 2012 },
   { "_id" : 5, "movie": "Iron Man 2", "Budget": 140000000, "year": 2013 },
   { "_id" : 6, "movie": "Iron Man 1", "Budget": 130000000, "year": 2013 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetWhenMatchMerge", "documents":[
   { "_id" : 1, "movie": "Iron Man 3", "Budget": 180000000, "year": 2011 },
   { "_id" : 2, "movie": "Captain America the winter soldier", "Budget": 170000000, "year": 2011 },
   { "_id" : 3, "movie": "Aveneger Endgame", "Budget": 160000000, "year": 2012 },
   { "_id" : 4, "movie": "Spider Man", "Budget": 150000000, "year": 2012 },
   { "_id" : 5, "movie": "Iron Man 2", "Budget": 140000000, "year": 2013 },
   { "_id" : 6, "movie": "Iron Man 1", "Budget": 130000000, "year": 2013 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

-- As all doc from source matches with target so there should not be any change in target collection. 
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceWhenMatchMerge", "pipeline": [  {"$merge" : { "into": "targetWhenMatchMerge", "whenMatched" : "merge" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                  cursorpage                                                                  | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceWhenMatchMerge", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document from documentdb_api.collection('db', 'targetWhenMatchMerge');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

-- Let's Add one more column by projection and see if it merges in target collection.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceWhenMatchMerge", 
"pipeline": [ 
               {"$project" : {"_id" : 1, "new_column" : "testing merge"}}, 
               {"$merge" : { "into": "targetWhenMatchMerge", "whenMatched" : "merge" }} 
            ], 
"cursor": { "batchSize": 1 } }', 4294967294);
                                                                  cursorpage                                                                  | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceWhenMatchMerge", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document from documentdb_api.collection('db', 'targetWhenMatchMerge');
                                                                                             document                                                                                              
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" }, "new_column" : "testing merge" }
(6 rows)

-- let's try to modify value of existing column of target collection. 
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceWhenMatchMerge", 
"pipeline": [ 
               {"$project" : {"_id" : 1, "year" : {"$add" : ["$year" , 1]}}}, 
               {"$merge" : { "into": "targetWhenMatchMerge", "whenMatched" : "merge" }} 
            ], 
"cursor": { "batchSize": 1 } }', 4294967294);
                                                                  cursorpage                                                                  | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceWhenMatchMerge", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document from documentdb_api.collection('db', 'targetWhenMatchMerge');
                                                                                             document                                                                                              
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2012" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2012" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2013" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2013" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2014" }, "new_column" : "testing merge" }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2014" }, "new_column" : "testing merge" }
(6 rows)

-- let's create index and match on other key and try to merge when _id field on source and target ID are same
SELECT documentdb_api.insert('db', '{"insert":"sourceDataMergeId", "documents":[{ "_id" : 1, "a": 10, "b" : 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataMergeId", "documents":[{ "_id" : 1, "a": 10  }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataMergeId", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataMergeId", "pipeline": [ {"$merge" : { "into": "targetDataMergeId", "on" : "a", "whenMatched" : "merge" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                cursorpage                                                                 | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceDataMergeId", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','targetDataMergeId');
                                             document                                             
--------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "10" } }
(1 row)

-- let's create index and match on other key and try to merge when _id field on source and target ID are different
SELECT documentdb_api.insert('db', '{"insert":"sourceDataMergeIdDiff", "documents":[{ "_id" : 1, "a": 10, "b" : 10 }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataMergeIdDiff", "documents":[{ "_id" : 2, "a": 10  }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataMergeIdDiff", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataMergeIdDiff", "pipeline": [ {"$merge" : { "into": "targetDataMergeIdDiff", "on" : "a", "whenMatched" : "merge" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge could not update the target document as an immutable field (like '_id' or shardKey) was detected to be modified.
SELECT document FROM documentdb_api.collection('db','targetDataMergeIdDiff');
                             document                              
-------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "10" } }
(1 row)

-- Now let's see what happens when we are not projecting _id from source and source _id is getting generated and if source objectID is generated then it will be not same as target's.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataMergeIdDiff", 
"pipeline": [  {"$project" : { "_id": 0 }},
               {"$merge" : { "into": "targetDataMergeIdDiff", "on" : "a", "whenMatched" : "merge" }} 
            ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                  cursorpage                                                                   | continuation | persistconnection | cursorid 
-----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceDataMergeIdDiff", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','targetDataMergeIdDiff');
                                             document                                             
--------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "10" } }
(1 row)

-- merge whenNotMatched fail
-- 1) this will not fail as all the doc from source are matching with target
SELECT documentdb_api.insert('db', '{"insert":"sourceNotMatchedFailed", "documents":[
   { "_id" : 1, "a": 1, "b": "a" },
   { "_id" : 2, "a": 2, "b": "b" },
   { "_id" : 3, "a": 3, "b": "c" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetNotMatchedFailed", "documents":[
   { "_id" : 1, "a": 1, "b": "e" },
   { "_id" : 2, "a": 2, "b": "f" },
   { "_id" : 3, "a": 3, "b": "g" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceNotMatchedFailed", 
                  "pipeline": [  
                                 {"$merge" : 
                                       { "into": "targetNotMatchedFailed", 
                                        "whenMatched" : "replace" ,
                                        "whenNotMatched" : "fail" }
                                 } 
                              ], 
                           "cursor": { "batchSize": 1 } 
               }',  4294967294
            );
                                                                   cursorpage                                                                   | continuation | persistconnection | cursorid 
------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceNotMatchedFailed", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document FROM documentdb_api.collection('db','targetNotMatchedFailed');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "a" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" }, "b" : "b" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : "c" }
(3 rows)

-- 2) this will fail as not one source doc is not matching with target and user has selected failure option.
SELECT documentdb_api.insert_one('db','sourceNotMatchedFailed',' { "_id" :  10, "a" : 1, "b" : 1 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceNotMatchedFailed", 
                  "pipeline": [  
                                 {"$merge" : 
                                       { "into": "targetNotMatchedFailed", 
                                        "whenMatched" : "replace" ,
                                        "whenNotMatched" : "fail" }
                                 } 
                              ] , "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge failed to locate a corresponding document in the target collection for one or more documents from the source collection
select document FROM documentdb_api.collection('db','targetNotMatchedFailed');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "a" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" }, "b" : "b" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : "c" }
(3 rows)

-- merge whenNotMatched Discard
SELECT documentdb_api.insert('db', '{"insert":"sourceNotMatchedDiscard", "documents":[
   { "_id" : 1, "a": 1, "b": "a" },
   { "_id" : 2, "a": 2, "b": "b" },
   { "_id" : 3, "a": 3, "b": "c" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetNotMatchedDiscard", "documents":[
   { "_id" : 1, "a": 1, "b": "e" },
   { "_id" : 5, "a": 2, "b": "f" },
   { "_id" : 6, "a": 3, "b": "g" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceNotMatchedDiscard", 
                  "pipeline": [  
                                 {"$merge" : 
                                       { "into": "targetNotMatchedDiscard", 
                                        "whenMatched" : "replace" ,
                                        "whenNotMatched" : "discard" }
                                 } 
                              ] , "cursor": { "batchSize": 1 } }', 4294967294);
                                                                   cursorpage                                                                    | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceNotMatchedDiscard", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document FROM documentdb_api.collection('db','targetNotMatchedDiscard');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "a" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "$numberInt" : "2" }, "b" : "f" }
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "3" }, "b" : "g" }
(3 rows)

-- WhanMathched : keepexisting
SELECT documentdb_api.insert('db', '{"insert":"sourceMatchedKeepExisting", "documents":[
   { "_id" : 1, "a": 1, "b": "a" },
   { "_id" : 2, "a": 2, "b": "b" },
   { "_id" : 3, "a": 3, "b": "c" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetMatchedKeepExisting", "documents":[
   { "_id" : 1, "a": 1, "b": "e" },
   { "_id" : 2, "a": 2, "b": "f" },
   { "_id" : 6, "a": 3, "b": "g" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceMatchedKeepExisting", 
                  "pipeline": [  
                                 {"$merge" : 
                                       { "into": "targetMatchedKeepExisting", 
                                        "whenMatched" : "keepExisting" ,
                                        "whenNotMatched" : "insert" }
                                 } 
                              ] , "cursor": { "batchSize": 1 } }', 4294967294);
                                                                    cursorpage                                                                     | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceMatchedKeepExisting", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

select document from documentdb_api.collection('db','targetMatchedKeepExisting');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "e" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" }, "b" : "f" }
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "3" }, "b" : "g" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : "c" }
(4 rows)

-- WhanMathched : fail
SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceMatchedKeepExisting", 
                  "pipeline": [  
                                 {"$merge" : 
                                       { "into": "targetMatchedKeepExisting", 
                                        "whenMatched" : "fail" ,
                                        "whenNotMatched" : "insert" }
                                 } 
                              ] , "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge with whenMatched: fail found an existing document with the same values for the 'on' fields
select document FROM documentdb_api.collection('db','targetMatchedKeepExisting');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "e" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" }, "b" : "f" }
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "3" }, "b" : "g" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : "c" }
(4 rows)

-- whenMatched : _id are getting changed in case of replace
SELECT documentdb_api.insert('db', '{"insert":"sourceMatchedIdTests", "documents":[
   { "_id" : 4, "a": 1, "b": "a" },
   { "_id" : 5, "a": 2, "b": "b" },
   { "_id" : 6, "a": 3, "b": "c" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetMatchedIdTests", "documents":[
   { "_id" : 1, "a": 1, "b": "e" },
   { "_id" : 2, "a": 2, "b": "f" },
   { "_id" : 6, "a": 3, "b": "g" }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetMatchedIdTests", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', 
               '{ 
                  "aggregate": "sourceMatchedIdTests", 
                  "pipeline": [  
                                 {"$merge" : 
                                       {
                                        "on" : "a", 
                                        "into": "targetMatchedIdTests", 
                                        "whenMatched" : "replace" ,
                                        "whenNotMatched" : "insert" }
                                 } 
                              ] , "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge could not update the target document as an immutable field (like '_id' or shardKey) was detected to be modified.
select document FROM documentdb_api.collection('db','targetMatchedIdTests');
                                  document                                   
-----------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : "e" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "2" }, "b" : "f" }
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "3" }, "b" : "g" }
(3 rows)

-- complex pipeline with last stage merge with replace and insert mode.
SELECT documentdb_api.insert_one('db','bson_agg_merge_src',' {"_id": 1, "company": "Company A", "products": ["product1", "product2"], "amount": 100 , "services": ["service1", "service2"]}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_src','{ "_id": 2, "company": "Company B", "products": ["product3", "product4"], "amount": 120, "services": ["service3"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_dest','{ "_id": 1, "item": "product1", "company_name": "Company A"}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_dest','{ "_id": 2, "item": "product3", "company_name": "Company B", "extra": "value1"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_dest','{ "_id": 3, "item": "product3", "company_name": "Company B", "extra": "value2"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "bson_agg_merge_dest", 
   "pipeline": 
    [ 
         { 
         "$lookup": 
             { 
                  "from": "bson_agg_merge_src", 
                  "pipeline": [ { "$match": { "amount": { "$gt": 110 } }}], 
                  "as": "joined_docs", 
                  "localField": "company_name", 
                  "foreignField": "company" 
             }
         },
         {"$sort"  : {"_id" :  -1}} ,
         {"$group" :{"_id" :  "$company_name"}},
         {"$project" : {"joined_docs" : 0}},
         {"$merge" : { "into": "bson_agg_merge_final", "whenMatched": "replace", "whenNotMatched": "insert" }} 
    ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.bson_agg_merge_dest", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','bson_agg_merge_final');
        document         
-------------------------
 { "_id" : "Company A" }
 { "_id" : "Company B" }
(2 rows)

-- when target collection has array 
SELECT documentdb_api.insert_one('db','bson_agg_merge_src_array',' { "_id" :  1, "a" : 1 }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_src_array',' { "_id" :  2, "a" : 5 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_dest_array',' { "_id" :  1, "a" : [1,2,3,4] }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "bson_agg_merge_dest_array", "indexes": [{"key": {"a": 1}, "name": "index_2", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "bson_agg_merge_src_array", "pipeline":[  {"$merge" : { "into": "bson_agg_merge_dest_array", "on" : "a", "whenMatched" : "replace", "whenNotMatched" : "insert" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                    cursorpage                                                                    | continuation | persistconnection | cursorid 
--------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.bson_agg_merge_src_array", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','bson_agg_merge_dest_array');
                             document                             
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "5" } }
(2 rows)

-- when query has sort clause
SELECT documentdb_api.insert_one('db','bson_agg_merge_sort_src','{ "_id": 1, "item": "product3", "company_name": "Company B", "extra": "value2"}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','bson_agg_merge_sort_src','{ "_id": 2, "item": "product5", "company_name": "Company C", "extra": "value3"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "bson_agg_merge_sort_src",  "pipeline": [  {"$sort"  : {"_id" :  -1}} , {"$merge" : { "into": "bson_agg_merge_sort_dest", "whenMatched": "replace", "whenNotMatched": "insert" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                   cursorpage                                                                    | continuation | persistconnection | cursorid 
-------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.bson_agg_merge_sort_src", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','bson_agg_merge_sort_dest');
                                                 document                                                  
-----------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "item" : "product5", "company_name" : "Company C", "extra" : "value3" }
 { "_id" : { "$numberInt" : "1" }, "item" : "product3", "company_name" : "Company B", "extra" : "value2" }
(2 rows)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "bson_agg_merge_dest",  "pipeline": [  {"$sort"  : {"_id" :  -1}} , {"$group" : {"_id" :  "$_id"}}, {"$merge" : { "into": "bson_agg_merge_sort_group", "whenMatched": "replace", "whenNotMatched": "insert" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                                 cursorpage                                                                  | continuation | persistconnection | cursorid 
---------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.bson_agg_merge_dest", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','bson_agg_merge_sort_group');
              document              
------------------------------------
 { "_id" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" } }
(3 rows)

-- when query has multiple sort clause or multiple resjunk columns
SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  1, "a" : 45, "b" : 10 }', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  2, "a" : 87, "b" : 7 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  3, "a" : 29, "b" : 17 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  4, "a" : 13, "b" : 99 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  5, "a" : 45, "b" : 113 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  6, "a" : 87, "b" : 76 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  7, "a" : 29, "b" : 86 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','resJunkSrc',' { "_id" :  8, "a" : 13, "b" : 20 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "resJunkSrc",  "pipeline": [  {"$sort"  : {"a" :  -1, "b" : 1}} , {"$merge" : { "into": "resJunkeTarget", "whenMatched": "replace", "whenNotMatched": "insert" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                             cursorpage                                                             | continuation | persistconnection | cursorid 
------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.resJunkSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db','resJunkeTarget');
                                             document                                              
---------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "87" }, "b" : { "$numberInt" : "7" } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "87" }, "b" : { "$numberInt" : "76" } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "45" }, "b" : { "$numberInt" : "10" } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "$numberInt" : "45" }, "b" : { "$numberInt" : "113" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "29" }, "b" : { "$numberInt" : "17" } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "$numberInt" : "29" }, "b" : { "$numberInt" : "86" } }
 { "_id" : { "$numberInt" : "8" }, "a" : { "$numberInt" : "13" }, "b" : { "$numberInt" : "20" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "$numberInt" : "13" }, "b" : { "$numberInt" : "99" } }
(8 rows)

-- test when source collection is view
SELECT documentdb_api.create_collection('db', 'sourceCollForView');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceCollForView", "documents":[{ "_id" : 1, "a" : 1, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceCollForView", "documents":[{ "_id" : 2, "a" : 2, "b" : 2  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceCollForView", "documents":[{ "_id" : 3, "a" : 3, "b" : 3  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.create_collection_view('db', '{ "create": "sourceView", "viewOn": "sourceCollForView", "pipeline": [ { "$project": { "_id": 1, "c" : {"$add" : ["$a","$b"]} } } ] }');
         create_collection_view         
----------------------------------------
 { "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceView", "pipeline": [  {"$merge" : { "into" : "targetViewedOutput" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                             cursorpage                                                             | continuation | persistconnection | cursorid 
------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.sourceView", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM  documentdb_api.collection('db', 'targetViewedOutput');
                             document                             
------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "3" }, "c" : { "$numberInt" : "6" } }
(3 rows)

-- Let's look at explain plan for unshared collection
SELECT documentdb_api.create_collection('db', 'sourceExplain');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceExplain", "documents":[{ "_id" : 1, "a" : 1, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceExplain", "documents":[{ "_id" : 2, "a" : 2, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceExplain", "documents":[{ "_id" : 3, "a" : 3, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceExplain", "documents":[{ "_id" : 4, "a" : 4, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"sourceExplain", "documents":[{ "_id" : 5, "a" : 5, "b" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "sourceExplain", "pipeline": [{"$merge" : { "into": "explainTarget", "whenMatched" : "replace" }} ] }');
NOTICE:  creating collection
                                              QUERY PLAN                                              
------------------------------------------------------------------------------------------------------
 Merge on documents_780053
   ->  Nested Loop Left Join
         Join Filter: (documents_780053.object_id = bson_get_value(collection.document, '_id'::text))
         ->  Bitmap Heap Scan on documents_780052 collection
               Recheck Cond: (shard_key_value = '780052'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '780052'::bigint)
         ->  Materialize
               ->  Bitmap Heap Scan on documents_780053
                     Recheck Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
(12 rows)

--explain when merge is not first stage of pipeline
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "sourceExplain", "pipeline": [{ "$match" : {"_id" :1}}, {"$merge" : { "into": "explainTarget", "whenMatched" : "replace" }} ] }');
                                                                        QUERY PLAN                                                                        
----------------------------------------------------------------------------------------------------------------------------------------------------------
 Merge on documents_780053
   ->  Nested Loop Left Join
         ->  Index Scan using _id_ on documents_780052 collection
               Index Cond: ((shard_key_value = '780052'::bigint) AND (object_id = '{ "" : { "$numberInt" : "1" } }'::bson))
         ->  Index Scan using _id_ on documents_780053
               Index Cond: ((shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint) AND (object_id = bson_get_value(collection.document, '_id'::text)))
(6 rows)

-- Let's look at explain plan for sharded collection
SELECT documentdb_api.shard_collection('db', 'sourceExplain', '{ "a": "hashed" }', false);
 shard_collection 
------------------
 
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "sourceExplain", "pipeline": [{"$merge" : { "into": "explainTarget", "whenMatched" : "replace" }} ] }');
                                              QUERY PLAN                                              
------------------------------------------------------------------------------------------------------
 Merge on documents_780053
   ->  Nested Loop Left Join
         Join Filter: (documents_780053.object_id = bson_get_value(collection.document, '_id'::text))
         ->  Seq Scan on documents_780052 collection
         ->  Materialize
               ->  Bitmap Heap Scan on documents_780053
                     Recheck Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
(9 rows)

-- Let's look at explain plan for when on field is indexed
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "sourceExplain", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "explainTarget", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- citus will wrap our query in a subquery: SELECT document, target_shard_key_value FROM (our query) AS subquery
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "sourceExplain", "pipeline": [{"$merge" : { "into": "explainTarget", "on" : "a", "whenMatched" : "replace" }} ] }');
                                                                     QUERY PLAN                                                                      
-----------------------------------------------------------------------------------------------------------------------------------------------------
 Merge on documents_780053
   ->  Nested Loop Left Join
         Join Filter: bson_dollar_merge_join(documents_780053.document, bson_dollar_extract_merge_filter(collection.document, 'a'::text), 'a'::text)
         ->  Seq Scan on documents_780052 collection
         ->  Materialize
               ->  Bitmap Heap Scan on documents_780053
                     Recheck Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (shard_key_value OPERATOR(pg_catalog.=) '780053'::bigint)
(9 rows)

-- source and target are same
SELECT documentdb_api.create_collection('db', 'AsSourceAsTarget');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db','AsSourceAsTarget',' { "_id" :  1, "a" : 1, "b" : 1 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM  aggregate_cursor_first_page('db', '{ "aggregate": "AsSourceAsTarget", "pipeline": [ {"$project" : {"new" : "data"}}, {"$merge" : { "into": "AsSourceAsTarget" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                cursorpage                                                                | continuation | persistconnection | cursorid 
------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.AsSourceAsTarget", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'AsSourceAsTarget');
                                                    document                                                    
----------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" }, "new" : "data" }
(1 row)

-- Negative tests : Invalid input
SELECT documentdb_api.create_collection('db', 'negInvalidInput');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : 1} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The $merge operator needs a string or object input, but received int instead
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : {  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The required BSON field '$merge.into' is missing.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "xman" : 1  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The BSON field '$merge.xman' is not recognized as a valid field.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : 1  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge 'into' field must contain either a string value or an object, but was given int instead
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : {"db" : "apple"}  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The 'into' field of $merge must define a collection name that is neither empty, null, nor undefined.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : {"db" : 1}  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  BSON field 'into.db' has an incorrect type 'object'; the expected data type is 'string'
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : {"db" : "database", "coll" :  1}  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  BSON field 'into.coll' has an incorrect type 'object'; the expected data type is 'string'
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : {"db" : "apple", "haha" : "haha"}  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  BSON field 'into.haha' is not recognized as a valid field
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "on" :  1  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The $merge 'on' field must be provided as either a single string or an array containing multiple strings, but received int instead.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "on" :  [1]  }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Array elements for $merge 'on' must be strings, but a int type was detected
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "whenMatched" : 1   }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The 'whenMatched' field in $merge needs to be a string value, but a int type was provided.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "whenMatched" : "falsevalue"   }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The enumeration value 'falsevalue' specified for the 'whenMatched' field is invalid.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "whenNotMatched" : 1   }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  BSON field '$merge.whenNotMatched' has an incorrect type 'int', but it should be of type 'string'
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl", "whenNotMatched" : "falsevalue"   }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The enumeration value 'falsevalue' provided for the field operator '$merge.whenNotMatched' is invalid.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl" }}, {} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  A pipeline stage specification object is required to have one and only one field.
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "outColl" }}, {"project" : {"a" : 1}
} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge must appear exclusively as the last stage in the pipeline
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into": "targetNotExists", "on" : [] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  When you explicitly set the operators merge to 'on', you are required to include at least one field.
-- Negative test cases when on fields value are not unique index.
SELECT documentdb_api.create_collection('db', 'indexNegColl');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db','indexNegColl',' { "_id" :  1, "a" : 1, "b" : 1 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.create_collection('db', 'indexNegOutColl');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"b": 1}, "name": "index_2", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"c": 1}, "name": "index_3", "unique" : false}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "2" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"d": 1}, "name": "index_A"}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "3" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"e": 1, "f" : 1, "g" : 1}, "name": "index_4"}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "4" }, "numIndexesAfter" : { "$numberInt" : "5" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"x": 1, "y" : 1, "z" : 1}, "name": "index_5", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "5" }, "numIndexesAfter" : { "$numberInt" : "6" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"parag": 1}, "name": "index_6", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "6" }, "numIndexesAfter" : { "$numberInt" : "7" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"jain": 1}, "name": "index_7", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "7" }, "numIndexesAfter" : { "$numberInt" : "8" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"partialTest": 1}, "name": "index_8", "unique" : true, "partialFilterExpression": {"a": {"$gt": 1}}}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "8" }, "numIndexesAfter" : { "$numberInt" : "9" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "indexNegOutColl", "indexes": [{"key": {"partialTest": 1, "partialTest2" : 1}, "name": "index_9", "unique" : true, "partialFilterExpression": {"a": {"$gt": 1}}}]}', true);
                                                                                                    create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "9" }, "numIndexesAfter" : { "$numberInt" : "10" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "c" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "d" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["b", "a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["b", "c"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["b", "d"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "e" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["f","g"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["e","f","g"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "f" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["x","z","y","f"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "x" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["x","z"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["x","_id"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["parag","jain"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["partialTest"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : "partialTest" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["partialTest", "partialTest2"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["a", "a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Duplicate field a detected
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["a", "b", "b"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Duplicate field b detected
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["c", "a", "c"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Duplicate field c detected
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["x","y"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "indexNegOutColl", "on" : ["z","x"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
-- _id Negative unique test
SELECT documentdb_api.insert_one('db','objectIDNegUniqueIndex',' { "_id" :  10, "a" : 1, "b" : 1, "c" : 1 , "d" : 1, "e" : 1, "f" : 1}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "objectIDTargetNegUniqueIndex", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "objectIDTargetNegUniqueIndex", "indexes": [{"key": {"b": 1}, "name": "index_2", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "2" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "objectIDTargetNegUniqueIndex", "indexes": [{"key": {"a": 1, "b" : 1}, "name": "index_3", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "3" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDNegUniqueIndex", "pipeline": [ {"$merge" : { "on" : ["_id", "a"],"into": "objectIDTargetNegUniqueIndex" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDNegUniqueIndex", "pipeline": [ {"$merge" : { "on" : ["a", "_id"], "into": "objectIDTargetNegUniqueIndex" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "objectIDNegUniqueIndex", "pipeline": [ {"$merge" : { "on" : ["a", "_id", "b"], "into": "objectIDTargetNegUniqueIndex" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
-- Negative tests : when target collection does not exist
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "targetNotExist", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "targetNotExist", "on" : ["a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "targetNotExist", "on" : ["_id","a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "indexNegColl", "pipeline": [  {"$merge" : { "into": "targetNotExist", "on" : ["a","_id"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Unable to locate index required to confirm join fields are unique
--Negative test when target collection is a view
SELECT documentdb_api.create_collection('db', 'targetCollForView');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetCollForView", "documents":[{ "_id" : 1, "a" : 1  }]}');
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.create_collection_view('db', '{ "create": "targetView", "viewOn": "targetCollForView", "pipeline": [ { "$sort": { "a": 1 } } ] }');
ERROR:  Namespace db.targetView already exists but with different configuration options: { "viewOn" : "aggregation_pipeline", "pipeline" : [ { "$project" : { "_id" : 1, "a" : 1 } } ] }
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "targetCollForView", "pipeline": [  {"$merge" : { "into" : "targetView" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The namespace db.targetView refers to a view object rather than a collection
--Negative tests : when on field is missing/array in source document
SELECT documentdb_api.insert('db', '{"insert":"sourceDataMissing", "documents":[{ "_id" : 3, "b": "c" }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.insert('db', '{"insert":"targetDataMissingTest", "documents":[{ "_id" : 3, "b": "c" }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataMissingTest", "indexes": [{"key": {"a": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataMissing", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataMissing", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" : ["a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT documentdb_api.insert('db', '{"insert":"sourceDataArray", "documents":[{ "_id" : 3, "a" : [1,2,3], "b": "c" }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataArray", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataArray", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" :  ["a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT documentdb_api.insert('db', '{"insert":"sourceDataNull", "documents":[{ "_id" : 3, "a" : null , "b": "c" }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataNull", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataNull", "pipeline": [  {"$merge" : { "into": "targetDataMissingTest", "on" :  ["a"] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  Write operation for $merge failed: the 'on' field must be provided and cannot be null, undefined, or an array
-- Negative test when non-Immutable function present in query
-- As in below query we call empty_data_table() which is non-Immutable function because targetcollection in lookup stage is empty.
SELECT documentdb_api.create_collection('db', 'nonImmutable');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db','nonImmutable',' { "_id" :  1, "a" : 1, "b" : 1 }', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM  aggregate_cursor_first_page('db', '{ "aggregate": "nonImmutable", "pipeline": [ {"$lookup": {"from": "bar", "as": "x", "localField": "f_id", "foreignField": "_id"}}, {"$merge" : { "into": "bar" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  The query references collections that do not exist. Create the missing collections and retry.
-- Merge inside transaction
BEGIN;
SELECT documentdb_api.insert('db', '{"insert":"insideTransaction", "documents":[{ "_id" : 3, "a" : 3, "b": "c" }]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "insideTransaction", "pipeline": [  {"$merge" : { "into": "targetTransaction", "on" : "a" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge is not permitted within an active transaction
END;
-- Option not supported failures
SELECT documentdb_api.create_collection('db', 'optionNotSupported');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "negInvalidInput", "pipeline": [  {"$merge" : { "into" : "optionNotSupportedOut", "whenMatched" : [] }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge 'whenMatched' with 'pipeline' not supported yet
SELECT documentdb_api.shard_collection('db', 'optionNotSupportedOut', '{ "a": "hashed" }', false);
NOTICE:  creating collection
 shard_collection 
------------------
 
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "optionNotSupported", "pipeline": [  {"$merge" : { "into" : "optionNotSupportedOut" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $merge for sharded output collection not supported yet
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "optionNotSupported", "pipeline": [  { "$match": { "name": "test" } }, {  "$graphLookup":  {"from": "optionNotSupported",  "startWith": "$id",  "connectFromField": "id", "connectToField": "ReportsTo", "as": "reportingHierarchy"}}, {"$merge":{ "into": "targetDataReplace"}}], "cursor": { "batchSize": 1 } }', 4294967294);
ERROR:  $graphLookup is not supported with $merge stage yet.
SELECT * FROM aggregate_cursor_first_page('sourceDB', '{ "aggregate": "sourceDumpData", "pipeline": [ {"$merge" : { "into": {"db" : "targetDB" , "coll" : "targetDumpData"}, "on" : "_id", "whenMatched" : "replace" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                                  cursorpage                                                                  | continuation | persistconnection | cursorid 
----------------------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "sourceDB.sourceDumpData", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

-- let's verify we insert or update proper data in database.
--try to insert 16 MB Document
SELECT documentdb_api.insert_one('db','sourceDataValidation','{ "_id": 1, "item": "a" }' , NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', FORMAT('{ "aggregate": "sourceDataValidation", "pipeline": [ {"$addFields" : { "newLargeField": "%s"} }, {"$merge" : {"into" : "targetDataValidation"}} ], "cursor": { "batchSize": 1 } }',repeat('a', 16*1024*1024) )::bson, 4294967294);
NOTICE:  creating collection
ERROR:  Size 16777262 is larger than MaxDocumentSize 16777216
--try to insert bad _id field
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataValidation", "pipeline": [ {"$project" : {"_id" : [1,2,3]}}, {"$merge" : {"into" : "targetDataValidation"}} ], "cursor": { "batchSize": 1 } }');
NOTICE:  creating collection
ERROR:  The '_id' field value must not be a type of array
-- try to update 16 MB document 
SELECT documentdb_api.insert_one('db','targetDataValidation','{ "_id": 1, "item": "a" }' , NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', FORMAT('{ "aggregate": "sourceDataValidation", "pipeline": [ {"$addFields" : { "newLargeField": "%s"} }, {"$merge" : {"into" : "targetDataValidation"}} ], "cursor": { "batchSize": 1 } }',repeat('a', 16*1024*1024) )::bson, 4294967294);
ERROR:  Size 16777262 is larger than MaxDocumentSize 16777216
--try to update bad _id field
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "targetDataValidation", "indexes": [{"key": {"item": 1}, "name": "index_1", "unique" : true}]}', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "sourceDataValidation", "pipeline": [ {"$project" : {"_id" : [1,2,3], "item" : 1}}, {"$merge" : {"into" : "targetDataValidation", "on" : "item"}} ], "cursor": { "batchSize": 1 } }');
ERROR:  The '_id' field value must not be a type of array
-- Basic Test with enable Native colocation
SET documentdb.enableNativeColocation=true; 
SELECT documentdb_api.insert('db', '{"insert":"nativeSrc", "documents":[
   { "_id" : 1, "movie": "Iron Man 3", "Budget": 180000000, "year": 2011 },
   { "_id" : 2, "movie": "Captain America the winter soldier", "Budget": 170000000, "year": 2011 },
   { "_id" : 3, "movie": "Aveneger Endgame", "Budget": 160000000, "year": 2012 },
   { "_id" : 4, "movie": "Spider Man", "Budget": 150000000, "year": 2012 },
   { "_id" : 5, "movie": "Iron Man 2", "Budget": 140000000, "year": 2013 },
   { "_id" : 6, "movie": "Iron Man 1", "Budget": 130000000, "year": 2013 }
]}');
NOTICE:  creating collection
                                         insert                                         
----------------------------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

--insert
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "nativeSrc", "pipeline": [  {"$merge" : { "into": "nativeTar" }} ], "cursor": { "batchSize": 1 } }', 4294967294);
NOTICE:  creating collection
                                                            cursorpage                                                             | continuation | persistconnection | cursorid 
-----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.nativeSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'nativeTar');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

--replace
SELECT * FROM aggregate_cursor_first_page('db', '{ "aggregate": "nativeSrc", "pipeline": [  {"$merge" : { "into": "nativeTar"}} ], "cursor": { "batchSize": 1 } }', 4294967294);
                                                            cursorpage                                                             | continuation | persistconnection | cursorid 
-----------------------------------------------------------------------------------------------------------------------------------+--------------+-------------------+----------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "db.nativeSrc", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } } |              | f                 |        0
(1 row)

SELECT document FROM documentdb_api.collection('db', 'nativeTar');
                                                                             document                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "movie" : "Iron Man 3", "Budget" : { "$numberInt" : "180000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "2" }, "movie" : "Captain America the winter soldier", "Budget" : { "$numberInt" : "170000000" }, "year" : { "$numberInt" : "2011" } }
 { "_id" : { "$numberInt" : "3" }, "movie" : "Aveneger Endgame", "Budget" : { "$numberInt" : "160000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "4" }, "movie" : "Spider Man", "Budget" : { "$numberInt" : "150000000" }, "year" : { "$numberInt" : "2012" } }
 { "_id" : { "$numberInt" : "5" }, "movie" : "Iron Man 2", "Budget" : { "$numberInt" : "140000000" }, "year" : { "$numberInt" : "2013" } }
 { "_id" : { "$numberInt" : "6" }, "movie" : "Iron Man 1", "Budget" : { "$numberInt" : "130000000" }, "year" : { "$numberInt" : "2013" } }
(6 rows)

SET documentdb.enableNativeColocation=false;
-- adding a test from reported bug
SELECT documentdb_api.create_collection('documentdb','patient');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

SELECT documentdb_api.create_collection('documentdb','patient2');
NOTICE:  creating collection
 create_collection 
-------------------
 t
(1 row)

select documentdb_api.insert_one('documentdb','patient', '{ "patient_id": "P001", "name": "Alice Smith", "age": 30, "phone_number": "555-0123", "registration_year": "2023","conditions": ["Diabetes", "Hypertension"]}');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

select documentdb_api.insert_one('documentdb','patient', '{ "patient_id": "P002", "name": "Bob Johnson", "age": 45, "phone_number": "555-0456", "registration_year": "2023", "conditions": ["Asthma"]}');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT cursorpage FROM documentdb_api.aggregate_cursor_first_page('documentdb', '{ "aggregate": "patient", "pipeline": [ {"$merge": "patient2"} ], "cursor": { "batchSize": 3 } }');
                                                               cursorpage                                                                
-----------------------------------------------------------------------------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "documentdb.patient", "firstBatch" : [  ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT count(document) FROM documentdb_api.collection('documentdb','patient2'); 
 count 
-------
     2
(1 row)


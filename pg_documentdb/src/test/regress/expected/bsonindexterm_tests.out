SET search_path TO documentdb_api,documentdb_api_catalog,documentdb_api_internal,documentdb_core;
SET documentdb.next_collection_id TO 800;
SET documentdb.next_collection_index_id TO 800;
-- test input output functions for bsonindexterm
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
         bson_to_bsonindexterm          
----------------------------------------
 BSONITERMHEX000c0000001024000100000000
(1 row)

SELECT 'BSONITERMHEX000c0000001024000100000000'::bsonindexterm;
             bsonindexterm              
----------------------------------------
 BSONITERMHEX000c0000001024000100000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX000c0000001024000100000000');
                        bsonindexterm_to_bson                        
---------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "0" } }
(1 row)

-- truncated flag is preserved
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }');
         bson_to_bsonindexterm          
----------------------------------------
 BSONITERMHEX010c0000001024000100000000
(1 row)

SELECT 'BSONITERMHEX010c0000001024000100000000'::bsonindexterm;
             bsonindexterm              
----------------------------------------
 BSONITERMHEX010c0000001024000100000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX010c0000001024000100000000');
                        bsonindexterm_to_bson                        
---------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "1" } }
(1 row)

-- value only is preserved and the serialized form is smaller
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }');
   bson_to_bsonindexterm    
----------------------------
 BSONITERMHEX05100001000000
(1 row)

SELECT 'BSONITERMHEX05100001000000'::bsonindexterm;
       bsonindexterm        
----------------------------
 BSONITERMHEX05100001000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX05100001000000');
                        bsonindexterm_to_bson                        
---------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "5" } }
(1 row)

-- descending is persisted too
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 128 }');
         bson_to_bsonindexterm          
----------------------------------------
 BSONITERMHEX800c0000001024000100000000
(1 row)

SELECT 'BSONITERMHEX800c0000001024000100000000'::bsonindexterm;
             bsonindexterm              
----------------------------------------
 BSONITERMHEX800c0000001024000100000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX800c0000001024000100000000');
                         bsonindexterm_to_bson                         
-----------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "128" } }
(1 row)

-- truncated flag is preserved
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 129 }');
         bson_to_bsonindexterm          
----------------------------------------
 BSONITERMHEX810c0000001024000100000000
(1 row)

SELECT 'BSONITERMHEX810c0000001024000100000000'::bsonindexterm;
             bsonindexterm              
----------------------------------------
 BSONITERMHEX810c0000001024000100000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX810c0000001024000100000000');
                         bsonindexterm_to_bson                         
-----------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "129" } }
(1 row)

-- value only is preserved and the serialized form is smaller
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 133 }');
   bson_to_bsonindexterm    
----------------------------
 BSONITERMHEX85100001000000
(1 row)

SELECT 'BSONITERMHEX85100001000000'::bsonindexterm;
       bsonindexterm        
----------------------------
 BSONITERMHEX85100001000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX85100001000000');
                         bsonindexterm_to_bson                         
-----------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "133" } }
(1 row)

-- serialization + deserialization with collation:
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 133, "$collation": "en_US" }');
          bson_to_bsonindexterm           
------------------------------------------
 BSONITERMHEXff656e5f55530085100001000000
(1 row)

SELECT 'BSONITERMHEXff656e5f55530085100001000000'::bsonindexterm;
              bsonindexterm               
------------------------------------------
 BSONITERMHEXff656e5f55530085100001000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEXff656e5f55530085100001000000');
                                     bsonindexterm_to_bson                                     
-----------------------------------------------------------------------------------------------
 { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "133" }, "$collation" : "en_US" }
(1 row)

-- composite term serialization
SELECT bson_to_bsonindexterm('{ "$$COMP": [{ "$": 1, "$flags": 133 }, { "$": 0, "$flags": 0 }, { "$": 3, "$flags": 0 }] }');
                                 bson_to_bsonindexterm                                  
----------------------------------------------------------------------------------------
 BSONITERMHEX0411851000010000001d000c00000010240000000000001d000c0000001024000300000000
(1 row)

SELECT 'BSONITERMHEX0411851000010000001d000c00000010240000000000001d000c0000001024000300000000'::bsonindexterm;
                                     bsonindexterm                                      
----------------------------------------------------------------------------------------
 BSONITERMHEX0411851000010000001d000c00000010240000000000001d000c0000001024000300000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEX0411851000010000001d000c00000010240000000000001d000c0000001024000300000000');
                                                                                                       bsonindexterm_to_bson                                                                                                        
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "$$COMP" : [ { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "133" } }, { "$" : { "$numberInt" : "0" }, "$flags" : { "$numberInt" : "0" } }, { "$" : { "$numberInt" : "3" }, "$flags" : { "$numberInt" : "0" } } ] }
(1 row)

-- composite term with collation:
SELECT bson_to_bsonindexterm('{ "$$COMP": [{ "$": 1, "$flags": 133 }, { "$": 0, "$flags": 0 }, { "$": 3, "$flags": 0 }], "$collation": "en_US" }');
                                        bson_to_bsonindexterm                                         
------------------------------------------------------------------------------------------------------
 BSONITERMHEXff656e5f5553000411851000010000001d000c00000010240000000000001d000c0000001024000300000000
(1 row)

SELECT 'BSONITERMHEXff656e5f5553000411851000010000001d000c00000010240000000000001d000c0000001024000300000000'::bsonindexterm;
                                            bsonindexterm                                             
------------------------------------------------------------------------------------------------------
 BSONITERMHEXff656e5f5553000411851000010000001d000c00000010240000000000001d000c0000001024000300000000
(1 row)

SELECT bsonindexterm_to_bson('BSONITERMHEXff656e5f5553000411851000010000001d000c00000010240000000000001d000c0000001024000300000000');
                                                                                                                   bsonindexterm_to_bson                                                                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "$$COMP" : [ { "$" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "133" } }, { "$" : { "$numberInt" : "0" }, "$flags" : { "$numberInt" : "0" } }, { "$" : { "$numberInt" : "3" }, "$flags" : { "$numberInt" : "0" } } ], "$collation" : "en_US" }
(1 row)

-- check btree comparisons
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }') = bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }') >= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }') > bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }') < bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 5 }') <= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

-- values being different
SELECT bson_to_bsonindexterm('{ "$": 2, "$flags": 5 }') = bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 2, "$flags": 5 }') >= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 2, "$flags": 5 }') > bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 2, "$flags": 5 }') < bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 2, "$flags": 5 }') <= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

-- truncation flag being different
SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }') = bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }') >= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }') > bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }') < bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": 1, "$flags": 1 }') <= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

-- undefined value is less than numbers.
SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') = bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') >= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') > bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') < bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') <= bson_to_bsonindexterm('{ "$": 1, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

-- undefined value is greater than MinKey.
SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') = bson_to_bsonindexterm('{ "$": { "$minKey": 1 }, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') >= bson_to_bsonindexterm('{ "$": { "$minKey": 1 }, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') > bson_to_bsonindexterm('{ "$": { "$minKey": 1 }, "$flags": 0 }');
 ?column? 
----------
 t
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') < bson_to_bsonindexterm('{ "$": { "$minKey": 1 }, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

SELECT bson_to_bsonindexterm('{ "$": null, "$flags": 8 }') <= bson_to_bsonindexterm('{ "$": { "$minKey": 1 }, "$flags": 0 }');
 ?column? 
----------
 f
(1 row)

-- collation based comparison
set documentdb_core.enablecollation to on;
SELECT bson_to_bsonindexterm('{ "$": "Apple", "$flags": 0, "$collation": "en-u-ks-level1" }') = bson_to_bsonindexterm('{ "$": "apple", "$flags": 0, "$collation": "en-u-ks-level2" }');
ERROR:  Cannot compare bson index terms with different collations
SELECT bson_to_bsonindexterm('{ "$": "Apple", "$flags": 0, "$collation": "en-u-ks-level1" }') = bson_to_bsonindexterm('{ "$": "apple", "$flags": 0, "$collation": "en-u-ks-level1" }');
 ?column? 
----------
 t
(1 row)


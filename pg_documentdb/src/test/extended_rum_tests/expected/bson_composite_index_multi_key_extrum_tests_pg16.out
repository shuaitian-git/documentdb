\i sql/bson_composite_index_multi_key_extrum_tests.sql
SET search_path TO documentdb_api,documentdb_core,documentdb_api_catalog;
SET documentdb.next_collection_id TO 1000;
SET documentdb.next_collection_index_id TO 1000;
set documentdb.enableCompositeReducedCorrelatedTerms to on;
set documentdb.enableUniqueCompositeReducedCorrelatedTerms to on;
-- now test query path pushdown
SELECT documentdb_api_internal.create_indexes_non_concurrently('mkey_db', '{ "createIndexes": "mkey_coll", "indexes": [ { "key": { "a.b": 1, "a.c": 1 }, "name": "a_b_c_1", "enableOrderedIndex": 1 } ] }');
psql:sql/bson_composite_index_multi_key_extrum_tests.sql:10: NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- multikey path on "a" - query on a.c can't be pushed
SELECT documentdb_api.insert_one('mkey_db', 'mkey_coll', '{ "_id": 1, "a": [ { "b": 1, "c": 1 }, { "b": 2, "c": 2 }] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

set documentdb.enableExtendedExplainPlans to on;
SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$gt": 0 }, "a.c": 2 }}') $cmd$);
                                                            run_explain_and_trim                                                             
---------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": (0, Infinity], "a.c": (MinKey, MaxKey)]
   numDuplicates: 1 entries
   innerScanLoops: 2 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: ((document @> '{ "a.b" : { "$numberInt" : "0" } }'::bson) AND (document @= '{ "a.c" : { "$numberInt" : "2" } }'::bson))
(12 rows)

SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": 1, "a.c": 2 }}') $cmd$);
                                                            run_explain_and_trim                                                             
---------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": [1, 1], "a.c": (MinKey, MaxKey)]
   innerScanLoops: 2 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 1)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: ((document @= '{ "a.b" : { "$numberInt" : "1" } }'::bson) AND (document @= '{ "a.c" : { "$numberInt" : "2" } }'::bson))
(11 rows)

-- order by doesn't work on secondary path (but works on the first one)
SELECT documentdb_test_helpers.run_explain_and_trim($cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$exists": true } }, "sort": { "a.b": 1, "a.c": 1 }, "hint": "a_b_c_1" }') $cmd$);
                                                                              run_explain_and_trim                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Incremental Sort (actual rows=1 loops=1)
   Sort Key: (bson_orderby(document, '{ "a.b" : { "$numberInt" : "1" } }'::bson)) NULLS FIRST, (bson_orderby(document, '{ "a.c" : { "$numberInt" : "1" } }'::bson)) NULLS FIRST
   Presorted Key: (bson_orderby(document, '{ "a.b" : { "$numberInt" : "1" } }'::bson))
   Full-sort Groups: 1  Sort Method: quicksort  Average Memory: 25kB  Peak Memory: 25kB
   ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
         indexName: a_b_c_1
         indexKey: {"a.b": 1,"a.c": 1}
         isMultiKey: true
         hasCorrelatedTerms: true
         indexBounds: ["a.b": [MinKey, MaxKey], "a.c": (MinKey, MaxKey)]
         numDuplicates: 1 entries
         innerScanLoops: 2 loops
         scanType: ordered
         scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
         ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
               Index Cond: (document @>= '{ "a.b" : { "$minKey" : 1 } }'::bson)
               Order By: (document |-<> '{ "a.b" : { "$numberInt" : "1" } }'::bson)
(17 rows)

SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$exists": true } }, "sort": { "a.b": -1 }, "hint": "a_b_c_1" }') $cmd$);
                                              run_explain_and_trim                                               
-----------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": [MinKey, MaxKey], "a.c": (MinKey, MaxKey)]
   numDuplicates: 1 entries
   isBackwardScan: true
   innerScanLoops: 3 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: (document @>= '{ "a.b" : { "$minKey" : 1 } }'::bson)
         Order By: (document OPERATOR(documentdb_api_internal.<>-|) '{ "a.b" : { "$numberInt" : "-1" } }'::bson)
(14 rows)

-- multikey on a.b - query on a.c can be pushed
TRUNCATE documentdb_data.documents_801;
psql:sql/bson_composite_index_multi_key_extrum_tests.sql:30: ERROR:  relation "documentdb_data.documents_801" does not exist
SELECT documentdb_api.insert_one('mkey_db', 'mkey_coll', '{ "_id": 1, "a": { "b": [ 1, 2 ], "c": 2 } }');
                                                                                                                       insert_one                                                                                                                        
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "n" : { "$numberInt" : "0" }, "ok" : { "$numberDouble" : "1.0" }, "writeErrors" : [ { "index" : { "$numberInt" : "0" }, "code" : { "$numberInt" : "319029277" }, "errmsg" : "Duplicate key violation on the requested collection: Index '_id_'" } ] }
(1 row)

SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$gt": 0 }, "a.c": 2 }}') $cmd$);
                                                            run_explain_and_trim                                                             
---------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": (0, Infinity], "a.c": (MinKey, MaxKey)]
   numDuplicates: 1 entries
   innerScanLoops: 2 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: ((document @> '{ "a.b" : { "$numberInt" : "0" } }'::bson) AND (document @= '{ "a.c" : { "$numberInt" : "2" } }'::bson))
(12 rows)

SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": 1, "a.c": 2 }}') $cmd$);
                                                            run_explain_and_trim                                                             
---------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": [1, 1], "a.c": (MinKey, MaxKey)]
   innerScanLoops: 2 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 1)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: ((document @= '{ "a.b" : { "$numberInt" : "1" } }'::bson) AND (document @= '{ "a.c" : { "$numberInt" : "2" } }'::bson))
(11 rows)

-- same behavior for order by.
SELECT documentdb_test_helpers.run_explain_and_trim($cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$exists": true } }, "sort": { "a.b": 1, "a.c": 1 }, "hint": "a_b_c_1" }') $cmd$);
                                                                              run_explain_and_trim                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Incremental Sort (actual rows=1 loops=1)
   Sort Key: (bson_orderby(document, '{ "a.b" : { "$numberInt" : "1" } }'::bson)) NULLS FIRST, (bson_orderby(document, '{ "a.c" : { "$numberInt" : "1" } }'::bson)) NULLS FIRST
   Presorted Key: (bson_orderby(document, '{ "a.b" : { "$numberInt" : "1" } }'::bson))
   Full-sort Groups: 1  Sort Method: quicksort  Average Memory: 25kB  Peak Memory: 25kB
   ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
         indexName: a_b_c_1
         indexKey: {"a.b": 1,"a.c": 1}
         isMultiKey: true
         hasCorrelatedTerms: true
         indexBounds: ["a.b": [MinKey, MaxKey], "a.c": (MinKey, MaxKey)]
         numDuplicates: 1 entries
         innerScanLoops: 2 loops
         scanType: ordered
         scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
         ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
               Index Cond: (document @>= '{ "a.b" : { "$minKey" : 1 } }'::bson)
               Order By: (document |-<> '{ "a.b" : { "$numberInt" : "1" } }'::bson)
(17 rows)

SELECT documentdb_test_helpers.run_explain_and_trim( $cmd$
    EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('mkey_db', '{ "find": "mkey_coll", "filter": { "a.b": { "$exists": true } }, "sort": { "a.b": -1 }, "hint": "a_b_c_1" }') $cmd$);
                                              run_explain_and_trim                                               
-----------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1 loops=1)
   indexName: a_b_c_1
   indexKey: {"a.b": 1,"a.c": 1}
   isMultiKey: true
   hasCorrelatedTerms: true
   indexBounds: ["a.b": [MinKey, MaxKey], "a.c": (MinKey, MaxKey)]
   numDuplicates: 1 entries
   isBackwardScan: true
   innerScanLoops: 3 loops
   scanType: ordered
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 2)]
   ->  Index Scan using a_b_c_1 on documents_1001 collection (actual rows=1 loops=1)
         Index Cond: (document @>= '{ "a.b" : { "$minKey" : 1 } }'::bson)
         Order By: (document OPERATOR(documentdb_api_internal.<>-|) '{ "a.b" : { "$numberInt" : "-1" } }'::bson)
(14 rows)

